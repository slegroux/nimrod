<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Convolution Neural Networks – slg_nimrod</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4ec7d0a1075ca37dcf8a21c3600a4173.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Convolution Neural Networks – slg_nimrod">
<meta property="og:description" content="minimal deep learning framework">
<meta property="og:image" content="https://slegroux.github.io/nimrod/models.conv_files/figure-html/cell-3-output-2.png">
<meta property="og:site_name" content="slg_nimrod">
<meta property="og:image:height" content="276">
<meta property="og:image:width" content="278">
<meta name="twitter:title" content="Convolution Neural Networks – slg_nimrod">
<meta name="twitter:description" content="minimal deep learning framework">
<meta name="twitter:image" content="https://slegroux.github.io/nimrod/models.conv_files/figure-html/cell-3-output-2.png">
<meta name="twitter:image-height" content="276">
<meta name="twitter:image-width" content="278">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">slg_nimrod</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Image</li><li class="breadcrumb-item"><a href="./models.autoencoders.html">Models</a></li><li class="breadcrumb-item"><a href="./models.conv.html">Convolution Neural Networks</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nimrod</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Audio</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./audio.datasets.stt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Speech to Text Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./audio.datasets.tts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Audio TTS Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
 <span class="menu-text">data.utils.lhotse.ipynb</span>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Embeddings</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./audio.embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Audio Embedders</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Utils</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./audio.utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Audio Utilities</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Image</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./image.datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Datasets</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.autoencoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AutoEncoders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.conv.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Convolution Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.mlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi Layer Perceptron</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Text</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
 <span class="menu-text">text.phonemizers.ipynb</span>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.normalizers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Normalizers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.tokenizers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text tokenizers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.aligners.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Aligners</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.ngram.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">N-gram Language Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.lm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Net Language Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer Language Models</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true">
 <span class="menu-text">Misc</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Core Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Core Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#conv-filters" id="toc-conv-filters" class="nav-link active" data-scroll-target="#conv-filters">Conv filters</a></li>
  <li><a href="#conv-block" id="toc-conv-block" class="nav-link" data-scroll-target="#conv-block">Conv Block</a>
  <ul class="collapse">
  <li><a href="#convblock" id="toc-convblock" class="nav-link" data-scroll-target="#convblock">ConvBlock</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">Usage</a></li>
  <li><a href="#configs" id="toc-configs" class="nav-link" data-scroll-target="#configs">Configs</a></li>
  </ul></li>
  <li><a href="#pre-activation-conv-block" id="toc-pre-activation-conv-block" class="nav-link" data-scroll-target="#pre-activation-conv-block">Pre-Activation Conv Block</a>
  <ul class="collapse">
  <li><a href="#preactivationconvblock" id="toc-preactivationconvblock" class="nav-link" data-scroll-target="#preactivationconvblock">PreActivationConvBlock</a></li>
  </ul></li>
  <li><a href="#deconv-block" id="toc-deconv-block" class="nav-link" data-scroll-target="#deconv-block">Deconv Block</a>
  <ul class="collapse">
  <li><a href="#deconvblock" id="toc-deconvblock" class="nav-link" data-scroll-target="#deconvblock">DeconvBlock</a></li>
  <li><a href="#usage-1" id="toc-usage-1" class="nav-link" data-scroll-target="#usage-1">Usage</a></li>
  </ul></li>
  <li><a href="#conv-deconv" id="toc-conv-deconv" class="nav-link" data-scroll-target="#conv-deconv">Conv-Deconv</a></li>
  <li><a href="#convnet" id="toc-convnet" class="nav-link" data-scroll-target="#convnet">ConvNet</a></li>
  <li><a href="#convnet-1" id="toc-convnet-1" class="nav-link" data-scroll-target="#convnet-1">ConvNet</a>
  <ul class="collapse">
  <li><a href="#usage-2" id="toc-usage-2" class="nav-link" data-scroll-target="#usage-2">Usage</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  </ul></li>
  <li><a href="#convnetx" id="toc-convnetx" class="nav-link" data-scroll-target="#convnetx">ConvNetX</a>
  <ul class="collapse">
  <li><a href="#convnetx-1" id="toc-convnetx-1" class="nav-link" data-scroll-target="#convnetx-1">ConvNetX</a></li>
  <li><a href="#usage-3" id="toc-usage-3" class="nav-link" data-scroll-target="#usage-3">Usage</a></li>
  <li><a href="#nimrod-training" id="toc-nimrod-training" class="nav-link" data-scroll-target="#nimrod-training">Nimrod training</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/slegroux/nimrod/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Image</li><li class="breadcrumb-item"><a href="./models.autoencoders.html">Models</a></li><li class="breadcrumb-item"><a href="./models.conv.html">Convolution Neural Networks</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Convolution Neural Networks</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="conv-filters" class="level2">
<h2 class="anchored" data-anchor-id="conv-filters">Conv filters</h2>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/data/image/mnist.yaml'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>dm <span class="op">=</span> instantiate(cfg)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dm.prepare_data()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dm.setup()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[14:49:25] INFO - Init ImageDataModule for mnist
[14:49:29] INFO - loading dataset mnist with args () from split train
[14:49:29] INFO - loading dataset mnist from split train</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[6], line 4</span>
<span class="ansi-green-fg ansi-bold">      2</span> cfg <span style="color:rgb(98,98,98)">=</span> OmegaConf<span style="color:rgb(98,98,98)">.</span>load(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">../config/data/image/mnist.yaml</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">      3</span> dm <span style="color:rgb(98,98,98)">=</span> instantiate(cfg)
<span class="ansi-green-fg">----&gt; 4</span> dm<span style="color:rgb(98,98,98)">.</span>prepare_data()
<span class="ansi-green-fg ansi-bold">      5</span> dm<span style="color:rgb(98,98,98)">.</span>setup()

File <span class="ansi-green-fg">~/Projects/nimrod/nimrod/image/datasets.py:415</span>, in <span class="ansi-cyan-fg">ImageDataModule.prepare_data</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    412</span> <span style="font-style:italic;color:rgb(175,0,0)">"""Download data if needed </span>
<span class="ansi-green-fg ansi-bold">    413</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    414</span> <span style="font-style:italic;color:rgb(95,135,135)"># train set</span>
<span class="ansi-green-fg">--&gt; 415</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>train_ds <span style="color:rgb(98,98,98)">=</span> ImageDataset(
<span class="ansi-green-fg ansi-bold">    416</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>hparams<span style="color:rgb(98,98,98)">.</span>name,
<span class="ansi-green-fg ansi-bold">    417</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args,
<span class="ansi-green-fg ansi-bold">    418</span>     data_dir <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>hparams<span style="color:rgb(98,98,98)">.</span>data_dir,
<span class="ansi-green-fg ansi-bold">    419</span>     split<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">train</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">    420</span>     transforms <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>hparams<span style="color:rgb(98,98,98)">.</span>transforms,
<span class="ansi-green-fg ansi-bold">    421</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>kwargs
<span class="ansi-green-fg ansi-bold">    422</span> )
<span class="ansi-green-fg ansi-bold">    423</span> <span style="font-style:italic;color:rgb(95,135,135)"># get num classes before setup method converst ImageDataset to Subset</span>
<span class="ansi-green-fg ansi-bold">    424</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_num_classes <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>train_ds<span style="color:rgb(98,98,98)">.</span>num_classes

File <span class="ansi-green-fg">~/Projects/nimrod/nimrod/image/datasets.py:228</span>, in <span class="ansi-cyan-fg">ImageDataset.__init__</span><span class="ansi-blue-fg">(self, name, data_dir, split, transforms, streaming, exclude_grey_scale, verification_mode, from_image_folder, from_disk, *args)</span>
<span class="ansi-green-fg ansi-bold">    226</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    227</span>     logger<span style="color:rgb(98,98,98)">.</span>info(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">loading dataset </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> from split </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>split<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">--&gt; 228</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>hf_ds <span style="color:rgb(98,98,98)">=</span> load_dataset(
<span class="ansi-green-fg ansi-bold">    229</span>         name,
<span class="ansi-green-fg ansi-bold">    230</span>         <span style="color:rgb(98,98,98)">*</span>args,
<span class="ansi-green-fg ansi-bold">    231</span>         split<span style="color:rgb(98,98,98)">=</span>split,
<span class="ansi-green-fg ansi-bold">    232</span>         cache_dir<span style="color:rgb(98,98,98)">=</span>data_dir,
<span class="ansi-green-fg ansi-bold">    233</span>         download_mode<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">reuse_dataset_if_exists</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">    234</span>         streaming<span style="color:rgb(98,98,98)">=</span>streaming,
<span class="ansi-green-fg ansi-bold">    235</span>         verification_mode<span style="color:rgb(98,98,98)">=</span>verification_mode
<span class="ansi-green-fg ansi-bold">    236</span>         
<span class="ansi-green-fg ansi-bold">    237</span>     )
<span class="ansi-green-fg ansi-bold">    239</span> <span style="font-style:italic;color:rgb(95,135,135)"># CHANGE IMAGE COLUMN NAME IF NEEDED</span>
<span class="ansi-green-fg ansi-bold">    240</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>image_column_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">image</span><span style="color:rgb(175,0,0)">'</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/load.py:2129</span>, in <span class="ansi-cyan-fg">load_dataset</span><span class="ansi-blue-fg">(path, name, data_dir, data_files, split, cache_dir, features, download_config, download_mode, verification_mode, keep_in_memory, save_infos, revision, token, streaming, num_proc, storage_options, trust_remote_code, **config_kwargs)</span>
<span class="ansi-green-fg ansi-bold">   2124</span> verification_mode <span style="color:rgb(98,98,98)">=</span> VerificationMode(
<span class="ansi-green-fg ansi-bold">   2125</span>     (verification_mode <span style="font-weight:bold;color:rgb(175,0,255)">or</span> VerificationMode<span style="color:rgb(98,98,98)">.</span>BASIC_CHECKS) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> save_infos <span style="font-weight:bold;color:rgb(0,135,0)">else</span> VerificationMode<span style="color:rgb(98,98,98)">.</span>ALL_CHECKS
<span class="ansi-green-fg ansi-bold">   2126</span> )
<span class="ansi-green-fg ansi-bold">   2128</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create a dataset builder</span>
<span class="ansi-green-fg">-&gt; 2129</span> builder_instance <span style="color:rgb(98,98,98)">=</span> load_dataset_builder(
<span class="ansi-green-fg ansi-bold">   2130</span>     path<span style="color:rgb(98,98,98)">=</span>path,
<span class="ansi-green-fg ansi-bold">   2131</span>     name<span style="color:rgb(98,98,98)">=</span>name,
<span class="ansi-green-fg ansi-bold">   2132</span>     data_dir<span style="color:rgb(98,98,98)">=</span>data_dir,
<span class="ansi-green-fg ansi-bold">   2133</span>     data_files<span style="color:rgb(98,98,98)">=</span>data_files,
<span class="ansi-green-fg ansi-bold">   2134</span>     cache_dir<span style="color:rgb(98,98,98)">=</span>cache_dir,
<span class="ansi-green-fg ansi-bold">   2135</span>     features<span style="color:rgb(98,98,98)">=</span>features,
<span class="ansi-green-fg ansi-bold">   2136</span>     download_config<span style="color:rgb(98,98,98)">=</span>download_config,
<span class="ansi-green-fg ansi-bold">   2137</span>     download_mode<span style="color:rgb(98,98,98)">=</span>download_mode,
<span class="ansi-green-fg ansi-bold">   2138</span>     revision<span style="color:rgb(98,98,98)">=</span>revision,
<span class="ansi-green-fg ansi-bold">   2139</span>     token<span style="color:rgb(98,98,98)">=</span>token,
<span class="ansi-green-fg ansi-bold">   2140</span>     storage_options<span style="color:rgb(98,98,98)">=</span>storage_options,
<span class="ansi-green-fg ansi-bold">   2141</span>     trust_remote_code<span style="color:rgb(98,98,98)">=</span>trust_remote_code,
<span class="ansi-green-fg ansi-bold">   2142</span>     _require_default_config_name<span style="color:rgb(98,98,98)">=</span>name <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">   2143</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>config_kwargs,
<span class="ansi-green-fg ansi-bold">   2144</span> )
<span class="ansi-green-fg ansi-bold">   2146</span> <span style="font-style:italic;color:rgb(95,135,135)"># Return iterable dataset in case of streaming</span>
<span class="ansi-green-fg ansi-bold">   2147</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> streaming:

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/load.py:1886</span>, in <span class="ansi-cyan-fg">load_dataset_builder</span><span class="ansi-blue-fg">(path, name, data_dir, data_files, cache_dir, features, download_config, download_mode, revision, token, storage_options, trust_remote_code, _require_default_config_name, **config_kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1884</span> builder_cls <span style="color:rgb(98,98,98)">=</span> get_dataset_builder_class(dataset_module, dataset_name<span style="color:rgb(98,98,98)">=</span>dataset_name)
<span class="ansi-green-fg ansi-bold">   1885</span> <span style="font-style:italic;color:rgb(95,135,135)"># Instantiate the dataset builder</span>
<span class="ansi-green-fg">-&gt; 1886</span> builder_instance: DatasetBuilder <span style="color:rgb(98,98,98)">=</span> builder_cls(
<span class="ansi-green-fg ansi-bold">   1887</span>     cache_dir<span style="color:rgb(98,98,98)">=</span>cache_dir,
<span class="ansi-green-fg ansi-bold">   1888</span>     dataset_name<span style="color:rgb(98,98,98)">=</span>dataset_name,
<span class="ansi-green-fg ansi-bold">   1889</span>     config_name<span style="color:rgb(98,98,98)">=</span>config_name,
<span class="ansi-green-fg ansi-bold">   1890</span>     data_dir<span style="color:rgb(98,98,98)">=</span>data_dir,
<span class="ansi-green-fg ansi-bold">   1891</span>     data_files<span style="color:rgb(98,98,98)">=</span>data_files,
<span class="ansi-green-fg ansi-bold">   1892</span>     <span style="color:rgb(0,135,0)">hash</span><span style="color:rgb(98,98,98)">=</span>dataset_module<span style="color:rgb(98,98,98)">.</span>hash,
<span class="ansi-green-fg ansi-bold">   1893</span>     info<span style="color:rgb(98,98,98)">=</span>info,
<span class="ansi-green-fg ansi-bold">   1894</span>     features<span style="color:rgb(98,98,98)">=</span>features,
<span class="ansi-green-fg ansi-bold">   1895</span>     token<span style="color:rgb(98,98,98)">=</span>token,
<span class="ansi-green-fg ansi-bold">   1896</span>     storage_options<span style="color:rgb(98,98,98)">=</span>storage_options,
<span class="ansi-green-fg ansi-bold">   1897</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>builder_kwargs,
<span class="ansi-green-fg ansi-bold">   1898</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>config_kwargs,
<span class="ansi-green-fg ansi-bold">   1899</span> )
<span class="ansi-green-fg ansi-bold">   1900</span> builder_instance<span style="color:rgb(98,98,98)">.</span>_use_legacy_cache_dir_if_possible(dataset_module)
<span class="ansi-green-fg ansi-bold">   1902</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> builder_instance

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/builder.py:342</span>, in <span class="ansi-cyan-fg">DatasetBuilder.__init__</span><span class="ansi-blue-fg">(self, cache_dir, dataset_name, config_name, hash, base_path, info, features, token, repo_id, data_files, data_dir, storage_options, writer_batch_size, **config_kwargs)</span>
<span class="ansi-green-fg ansi-bold">    340</span>     config_kwargs[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">data_dir</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> data_dir
<span class="ansi-green-fg ansi-bold">    341</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>config_kwargs <span style="color:rgb(98,98,98)">=</span> config_kwargs
<span class="ansi-green-fg">--&gt; 342</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>config, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>config_id <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_create_builder_config(
<span class="ansi-green-fg ansi-bold">    343</span>     config_name<span style="color:rgb(98,98,98)">=</span>config_name,
<span class="ansi-green-fg ansi-bold">    344</span>     custom_features<span style="color:rgb(98,98,98)">=</span>features,
<span class="ansi-green-fg ansi-bold">    345</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>config_kwargs,
<span class="ansi-green-fg ansi-bold">    346</span> )
<span class="ansi-green-fg ansi-bold">    348</span> <span style="font-style:italic;color:rgb(95,135,135)"># prepare info: DatasetInfo are a standardized dataclass across all datasets</span>
<span class="ansi-green-fg ansi-bold">    349</span> <span style="font-style:italic;color:rgb(95,135,135)"># Prefill datasetinfo</span>
<span class="ansi-green-fg ansi-bold">    350</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> info <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    351</span>     <span style="font-style:italic;color:rgb(95,135,135)"># TODO FOR PACKAGED MODULES IT IMPORTS DATA FROM src/packaged_modules which doesn't make sense</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/builder.py:597</span>, in <span class="ansi-cyan-fg">DatasetBuilder._create_builder_config</span><span class="ansi-blue-fg">(self, config_name, custom_features, **config_kwargs)</span>
<span class="ansi-green-fg ansi-bold">    594</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">BuilderConfig must have a name, got </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>builder_config<span style="color:rgb(98,98,98)">.</span>name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    596</span> <span style="font-style:italic;color:rgb(95,135,135)"># resolve data files if needed</span>
<span class="ansi-green-fg">--&gt; 597</span> builder_config<span style="color:rgb(98,98,98)">.</span>_resolve_data_files(
<span class="ansi-green-fg ansi-bold">    598</span>     base_path<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>base_path,
<span class="ansi-green-fg ansi-bold">    599</span>     download_config<span style="color:rgb(98,98,98)">=</span>DownloadConfig(token<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>token, storage_options<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>storage_options),
<span class="ansi-green-fg ansi-bold">    600</span> )
<span class="ansi-green-fg ansi-bold">    602</span> <span style="font-style:italic;color:rgb(95,135,135)"># compute the config id that is going to be used for caching</span>
<span class="ansi-green-fg ansi-bold">    603</span> config_id <span style="color:rgb(98,98,98)">=</span> builder_config<span style="color:rgb(98,98,98)">.</span>create_config_id(
<span class="ansi-green-fg ansi-bold">    604</span>     config_kwargs,
<span class="ansi-green-fg ansi-bold">    605</span>     custom_features<span style="color:rgb(98,98,98)">=</span>custom_features,
<span class="ansi-green-fg ansi-bold">    606</span> )

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/builder.py:206</span>, in <span class="ansi-cyan-fg">BuilderConfig._resolve_data_files</span><span class="ansi-blue-fg">(self, base_path, download_config)</span>
<span class="ansi-green-fg ansi-bold">    204</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>data_files, DataFilesPatternsDict):
<span class="ansi-green-fg ansi-bold">    205</span>     base_path <span style="color:rgb(98,98,98)">=</span> xjoin(base_path, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>data_dir) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>data_dir <span style="font-weight:bold;color:rgb(0,135,0)">else</span> base_path
<span class="ansi-green-fg">--&gt; 206</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>data_files <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>data_files<span style="color:rgb(98,98,98)">.</span>resolve(base_path, download_config)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/data_files.py:818</span>, in <span class="ansi-cyan-fg">DataFilesPatternsDict.resolve</span><span class="ansi-blue-fg">(self, base_path, download_config)</span>
<span class="ansi-green-fg ansi-bold">    816</span> out <span style="color:rgb(98,98,98)">=</span> DataFilesDict()
<span class="ansi-green-fg ansi-bold">    817</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> key, data_files_patterns_list <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>items():
<span class="ansi-green-fg">--&gt; 818</span>     out[key] <span style="color:rgb(98,98,98)">=</span> data_files_patterns_list<span style="color:rgb(98,98,98)">.</span>resolve(base_path, download_config)
<span class="ansi-green-fg ansi-bold">    819</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> out

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/data_files.py:771</span>, in <span class="ansi-cyan-fg">DataFilesPatternsList.resolve</span><span class="ansi-blue-fg">(self, base_path, download_config)</span>
<span class="ansi-green-fg ansi-bold">    768</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> pattern, allowed_extensions <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>allowed_extensions):
<span class="ansi-green-fg ansi-bold">    769</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    770</span>         data_files<span style="color:rgb(98,98,98)">.</span>extend(
<span class="ansi-green-fg">--&gt; 771</span>             resolve_pattern(
<span class="ansi-green-fg ansi-bold">    772</span>                 pattern,
<span class="ansi-green-fg ansi-bold">    773</span>                 base_path<span style="color:rgb(98,98,98)">=</span>base_path,
<span class="ansi-green-fg ansi-bold">    774</span>                 allowed_extensions<span style="color:rgb(98,98,98)">=</span>allowed_extensions,
<span class="ansi-green-fg ansi-bold">    775</span>                 download_config<span style="color:rgb(98,98,98)">=</span>download_config,
<span class="ansi-green-fg ansi-bold">    776</span>             )
<span class="ansi-green-fg ansi-bold">    777</span>         )
<span class="ansi-green-fg ansi-bold">    778</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">FileNotFoundError</span>:
<span class="ansi-green-fg ansi-bold">    779</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> has_magic(pattern):

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/datasets/data_files.py:388</span>, in <span class="ansi-cyan-fg">resolve_pattern</span><span class="ansi-blue-fg">(pattern, base_path, allowed_extensions, download_config)</span>
<span class="ansi-green-fg ansi-bold">    383</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> protocol <span style="color:rgb(98,98,98)">==</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">hf</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> config<span style="color:rgb(98,98,98)">.</span>HF_HUB_VERSION <span style="color:rgb(98,98,98)">&gt;</span><span style="color:rgb(98,98,98)">=</span> version<span style="color:rgb(98,98,98)">.</span>parse(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">0.20.0</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    384</span>     <span style="font-style:italic;color:rgb(95,135,135)"># 10 times faster glob with detail=True (ignores costly info like lastCommit)</span>
<span class="ansi-green-fg ansi-bold">    385</span>     glob_kwargs[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">expand_info</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg ansi-bold">    386</span> matched_paths <span style="color:rgb(98,98,98)">=</span> [
<span class="ansi-green-fg ansi-bold">    387</span>     filepath <span style="font-weight:bold;color:rgb(0,135,0)">if</span> filepath<span style="color:rgb(98,98,98)">.</span>startswith(protocol_prefix) <span style="font-weight:bold;color:rgb(0,135,0)">else</span> protocol_prefix <span style="color:rgb(98,98,98)">+</span> filepath
<span class="ansi-green-fg">--&gt; 388</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> filepath, info <span style="font-weight:bold;color:rgb(175,0,255)">in</span> fs<span style="color:rgb(98,98,98)">.</span>glob(pattern, detail<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>glob_kwargs)<span style="color:rgb(98,98,98)">.</span>items()
<span class="ansi-green-fg ansi-bold">    389</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> info[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">type</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">==</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">file</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    390</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> (xbasename(filepath) <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> files_to_ignore)
<span class="ansi-green-fg ansi-bold">    391</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> _is_inside_unrequested_special_dir(filepath, fs_pattern)
<span class="ansi-green-fg ansi-bold">    392</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> _is_unrequested_hidden_file_or_is_inside_unrequested_hidden_dir(filepath, fs_pattern)
<span class="ansi-green-fg ansi-bold">    393</span> ]  <span style="font-style:italic;color:rgb(95,135,135)"># ignore .ipynb and __pycache__, but keep /../</span>
<span class="ansi-green-fg ansi-bold">    394</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> allowed_extensions <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    395</span>     out <span style="color:rgb(98,98,98)">=</span> [
<span class="ansi-green-fg ansi-bold">    396</span>         filepath
<span class="ansi-green-fg ansi-bold">    397</span>         <span style="font-weight:bold;color:rgb(0,135,0)">for</span> filepath <span style="font-weight:bold;color:rgb(175,0,255)">in</span> matched_paths
<span class="ansi-green-fg ansi-bold">    398</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">any</span>(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span> <span style="color:rgb(98,98,98)">+</span> suffix <span style="font-weight:bold;color:rgb(175,0,255)">in</span> allowed_extensions <span style="font-weight:bold;color:rgb(0,135,0)">for</span> suffix <span style="font-weight:bold;color:rgb(175,0,255)">in</span> xbasename(filepath)<span style="color:rgb(98,98,98)">.</span>split(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>)[<span style="color:rgb(98,98,98)">1</span>:])
<span class="ansi-green-fg ansi-bold">    399</span>     ]

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/hf_file_system.py:521</span>, in <span class="ansi-cyan-fg">HfFileSystem.glob</span><span class="ansi-blue-fg">(self, path, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    519</span> kwargs <span style="color:rgb(98,98,98)">=</span> {<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">expand_info</span><span style="color:rgb(175,0,0)">"</span>: kwargs<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">detail</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">False</span>), <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs}
<span class="ansi-green-fg ansi-bold">    520</span> path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>resolve_path(path, revision<span style="color:rgb(98,98,98)">=</span>kwargs<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">revision</span><span style="color:rgb(175,0,0)">"</span>))<span style="color:rgb(98,98,98)">.</span>unresolve()
<span class="ansi-green-fg">--&gt; 521</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">super</span>()<span style="color:rgb(98,98,98)">.</span>glob(path, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/fsspec/spec.py:611</span>, in <span class="ansi-cyan-fg">AbstractFileSystem.glob</span><span class="ansi-blue-fg">(self, path, maxdepth, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    608</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    609</span>         depth <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 611</span> allpaths <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>find(root, maxdepth<span style="color:rgb(98,98,98)">=</span>depth, withdirs<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>, detail<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">    613</span> pattern <span style="color:rgb(98,98,98)">=</span> glob_translate(path <span style="color:rgb(98,98,98)">+</span> (<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">/</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ends_with_sep <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">"</span>))
<span class="ansi-green-fg ansi-bold">    614</span> pattern <span style="color:rgb(98,98,98)">=</span> re<span style="color:rgb(98,98,98)">.</span>compile(pattern)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/hf_file_system.py:556</span>, in <span class="ansi-cyan-fg">HfFileSystem.find</span><span class="ansi-blue-fg">(self, path, maxdepth, withdirs, detail, refresh, revision, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    533</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    534</span> <span style="font-style:italic;color:rgb(175,0,0)">List all files below path.</span>
<span class="ansi-green-fg ansi-bold">    535</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    553</span> <span style="font-style:italic;color:rgb(175,0,0)">    `Union[List[str], Dict[str, Dict[str, Any]]]`: List of paths or dict of file information.</span>
<span class="ansi-green-fg ansi-bold">    554</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    555</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> maxdepth:
<span class="ansi-green-fg">--&gt; 556</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">super</span>()<span style="color:rgb(98,98,98)">.</span>find(
<span class="ansi-green-fg ansi-bold">    557</span>         path, maxdepth<span style="color:rgb(98,98,98)">=</span>maxdepth, withdirs<span style="color:rgb(98,98,98)">=</span>withdirs, detail<span style="color:rgb(98,98,98)">=</span>detail, refresh<span style="color:rgb(98,98,98)">=</span>refresh, revision<span style="color:rgb(98,98,98)">=</span>revision, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs
<span class="ansi-green-fg ansi-bold">    558</span>     )
<span class="ansi-green-fg ansi-bold">    559</span> resolved_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>resolve_path(path, revision<span style="color:rgb(98,98,98)">=</span>revision)
<span class="ansi-green-fg ansi-bold">    560</span> path <span style="color:rgb(98,98,98)">=</span> resolved_path<span style="color:rgb(98,98,98)">.</span>unresolve()

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/fsspec/spec.py:502</span>, in <span class="ansi-cyan-fg">AbstractFileSystem.find</span><span class="ansi-blue-fg">(self, path, maxdepth, withdirs, detail, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    499</span> <span style="font-style:italic;color:rgb(95,135,135)"># Add the root directory if withdirs is requested</span>
<span class="ansi-green-fg ansi-bold">    500</span> <span style="font-style:italic;color:rgb(95,135,135)"># This is needed for posix glob compliance</span>
<span class="ansi-green-fg ansi-bold">    501</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> withdirs <span style="font-weight:bold;color:rgb(175,0,255)">and</span> path <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>isdir(path):
<span class="ansi-green-fg">--&gt; 502</span>     out[path] <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>info(path)
<span class="ansi-green-fg ansi-bold">    504</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> _, dirs, files <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>walk(path, maxdepth, detail<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">    505</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> withdirs:

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/hf_file_system.py:719</span>, in <span class="ansi-cyan-fg">HfFileSystem.info</span><span class="ansi-blue-fg">(self, path, refresh, revision, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    717</span>     out <span style="color:rgb(98,98,98)">=</span> out1[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg ansi-bold">    718</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> refresh <span style="font-weight:bold;color:rgb(175,0,255)">or</span> out <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">or</span> (expand_info <span style="font-weight:bold;color:rgb(175,0,255)">and</span> out <span style="font-weight:bold;color:rgb(175,0,255)">and</span> out[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">last_commit</span><span style="color:rgb(175,0,0)">"</span>] <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>):
<span class="ansi-green-fg">--&gt; 719</span>     paths_info <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_api<span style="color:rgb(98,98,98)">.</span>get_paths_info(
<span class="ansi-green-fg ansi-bold">    720</span>         resolved_path<span style="color:rgb(98,98,98)">.</span>repo_id,
<span class="ansi-green-fg ansi-bold">    721</span>         resolved_path<span style="color:rgb(98,98,98)">.</span>path_in_repo,
<span class="ansi-green-fg ansi-bold">    722</span>         expand<span style="color:rgb(98,98,98)">=</span>expand_info,
<span class="ansi-green-fg ansi-bold">    723</span>         revision<span style="color:rgb(98,98,98)">=</span>resolved_path<span style="color:rgb(98,98,98)">.</span>revision,
<span class="ansi-green-fg ansi-bold">    724</span>         repo_type<span style="color:rgb(98,98,98)">=</span>resolved_path<span style="color:rgb(98,98,98)">.</span>repo_type,
<span class="ansi-green-fg ansi-bold">    725</span>     )
<span class="ansi-green-fg ansi-bold">    726</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> paths_info:
<span class="ansi-green-fg ansi-bold">    727</span>         _raise_file_not_found(path, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/utils/_validators.py:114</span>, in <span class="ansi-cyan-fg">validate_hf_hub_args.&lt;locals&gt;._inner_fn</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    111</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> check_use_auth_token:
<span class="ansi-green-fg ansi-bold">    112</span>     kwargs <span style="color:rgb(98,98,98)">=</span> smoothly_deprecate_use_auth_token(fn_name<span style="color:rgb(98,98,98)">=</span>fn<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span>, has_token<span style="color:rgb(98,98,98)">=</span>has_token, kwargs<span style="color:rgb(98,98,98)">=</span>kwargs)
<span class="ansi-green-fg">--&gt; 114</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> fn(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/hf_api.py:3295</span>, in <span class="ansi-cyan-fg">HfApi.get_paths_info</span><span class="ansi-blue-fg">(self, repo_id, paths, expand, revision, repo_type, token)</span>
<span class="ansi-green-fg ansi-bold">   3292</span> revision <span style="color:rgb(98,98,98)">=</span> quote(revision, safe<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">"</span>) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> revision <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> constants<span style="color:rgb(98,98,98)">.</span>DEFAULT_REVISION
<span class="ansi-green-fg ansi-bold">   3293</span> headers <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_build_hf_headers(token<span style="color:rgb(98,98,98)">=</span>token)
<span class="ansi-green-fg">-&gt; 3295</span> response <span style="color:rgb(98,98,98)">=</span> get_session()<span style="color:rgb(98,98,98)">.</span>post(
<span class="ansi-green-fg ansi-bold">   3296</span>     <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>endpoint<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">/api/</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>repo_type<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">s/</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>repo_id<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">/paths-info/</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>revision<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">   3297</span>     data<span style="color:rgb(98,98,98)">=</span>{
<span class="ansi-green-fg ansi-bold">   3298</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">paths</span><span style="color:rgb(175,0,0)">"</span>: paths <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(paths, <span style="color:rgb(0,135,0)">list</span>) <span style="font-weight:bold;color:rgb(0,135,0)">else</span> [paths],
<span class="ansi-green-fg ansi-bold">   3299</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">expand</span><span style="color:rgb(175,0,0)">"</span>: expand,
<span class="ansi-green-fg ansi-bold">   3300</span>     },
<span class="ansi-green-fg ansi-bold">   3301</span>     headers<span style="color:rgb(98,98,98)">=</span>headers,
<span class="ansi-green-fg ansi-bold">   3302</span> )
<span class="ansi-green-fg ansi-bold">   3303</span> hf_raise_for_status(response)
<span class="ansi-green-fg ansi-bold">   3304</span> paths_info <span style="color:rgb(98,98,98)">=</span> response<span style="color:rgb(98,98,98)">.</span>json()

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:637</span>, in <span class="ansi-cyan-fg">Session.post</span><span class="ansi-blue-fg">(self, url, data, json, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    626</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">post</span>(<span style="color:rgb(0,135,0)">self</span>, url, data<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, json<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">    627</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Sends a POST request. Returns :class:`Response` object.</span>
<span class="ansi-green-fg ansi-bold">    628</span> 
<span class="ansi-green-fg ansi-bold">    629</span> <span style="font-style:italic;color:rgb(175,0,0)">    :param url: URL for the new :class:`Request` object.</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    634</span> <span style="font-style:italic;color:rgb(175,0,0)">    :rtype: requests.Response</span>
<span class="ansi-green-fg ansi-bold">    635</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 637</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>request(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">POST</span><span style="color:rgb(175,0,0)">"</span>, url, data<span style="color:rgb(98,98,98)">=</span>data, json<span style="color:rgb(98,98,98)">=</span>json, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:589</span>, in <span class="ansi-cyan-fg">Session.request</span><span class="ansi-blue-fg">(self, method, url, params, data, headers, cookies, files, auth, timeout, allow_redirects, proxies, hooks, stream, verify, cert, json)</span>
<span class="ansi-green-fg ansi-bold">    584</span> send_kwargs <span style="color:rgb(98,98,98)">=</span> {
<span class="ansi-green-fg ansi-bold">    585</span>     <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">timeout</span><span style="color:rgb(175,0,0)">"</span>: timeout,
<span class="ansi-green-fg ansi-bold">    586</span>     <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">allow_redirects</span><span style="color:rgb(175,0,0)">"</span>: allow_redirects,
<span class="ansi-green-fg ansi-bold">    587</span> }
<span class="ansi-green-fg ansi-bold">    588</span> send_kwargs<span style="color:rgb(98,98,98)">.</span>update(settings)
<span class="ansi-green-fg">--&gt; 589</span> resp <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>send(prep, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>send_kwargs)
<span class="ansi-green-fg ansi-bold">    591</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> resp

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:724</span>, in <span class="ansi-cyan-fg">Session.send</span><span class="ansi-blue-fg">(self, request, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    721</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> allow_redirects:
<span class="ansi-green-fg ansi-bold">    722</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Redirect resolving generator.</span>
<span class="ansi-green-fg ansi-bold">    723</span>     gen <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>resolve_redirects(r, request, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">--&gt; 724</span>     history <span style="color:rgb(98,98,98)">=</span> [resp <span style="font-weight:bold;color:rgb(0,135,0)">for</span> resp <span style="font-weight:bold;color:rgb(175,0,255)">in</span> gen]
<span class="ansi-green-fg ansi-bold">    725</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    726</span>     history <span style="color:rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:724</span>, in <span class="ansi-cyan-fg">&lt;listcomp&gt;</span><span class="ansi-blue-fg">(.0)</span>
<span class="ansi-green-fg ansi-bold">    721</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> allow_redirects:
<span class="ansi-green-fg ansi-bold">    722</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Redirect resolving generator.</span>
<span class="ansi-green-fg ansi-bold">    723</span>     gen <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>resolve_redirects(r, request, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">--&gt; 724</span>     history <span style="color:rgb(98,98,98)">=</span> [resp <span style="font-weight:bold;color:rgb(0,135,0)">for</span> resp <span style="font-weight:bold;color:rgb(175,0,255)">in</span> gen]
<span class="ansi-green-fg ansi-bold">    725</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    726</span>     history <span style="color:rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:265</span>, in <span class="ansi-cyan-fg">SessionRedirectMixin.resolve_redirects</span><span class="ansi-blue-fg">(self, resp, req, stream, timeout, verify, cert, proxies, yield_requests, **adapter_kwargs)</span>
<span class="ansi-green-fg ansi-bold">    263</span>     <span style="font-weight:bold;color:rgb(0,135,0)">yield</span> req
<span class="ansi-green-fg ansi-bold">    264</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">--&gt; 265</span>     resp <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>send(
<span class="ansi-green-fg ansi-bold">    266</span>         req,
<span class="ansi-green-fg ansi-bold">    267</span>         stream<span style="color:rgb(98,98,98)">=</span>stream,
<span class="ansi-green-fg ansi-bold">    268</span>         timeout<span style="color:rgb(98,98,98)">=</span>timeout,
<span class="ansi-green-fg ansi-bold">    269</span>         verify<span style="color:rgb(98,98,98)">=</span>verify,
<span class="ansi-green-fg ansi-bold">    270</span>         cert<span style="color:rgb(98,98,98)">=</span>cert,
<span class="ansi-green-fg ansi-bold">    271</span>         proxies<span style="color:rgb(98,98,98)">=</span>proxies,
<span class="ansi-green-fg ansi-bold">    272</span>         allow_redirects<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">    273</span>         <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>adapter_kwargs,
<span class="ansi-green-fg ansi-bold">    274</span>     )
<span class="ansi-green-fg ansi-bold">    276</span>     extract_cookies_to_jar(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>cookies, prepared_request, resp<span style="color:rgb(98,98,98)">.</span>raw)
<span class="ansi-green-fg ansi-bold">    278</span>     <span style="font-style:italic;color:rgb(95,135,135)"># extract redirect url, if any, for the next loop</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/sessions.py:703</span>, in <span class="ansi-cyan-fg">Session.send</span><span class="ansi-blue-fg">(self, request, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    700</span> start <span style="color:rgb(98,98,98)">=</span> preferred_clock()
<span class="ansi-green-fg ansi-bold">    702</span> <span style="font-style:italic;color:rgb(95,135,135)"># Send the request</span>
<span class="ansi-green-fg">--&gt; 703</span> r <span style="color:rgb(98,98,98)">=</span> adapter<span style="color:rgb(98,98,98)">.</span>send(request, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">    705</span> <span style="font-style:italic;color:rgb(95,135,135)"># Total elapsed time of the request (approximately)</span>
<span class="ansi-green-fg ansi-bold">    706</span> elapsed <span style="color:rgb(98,98,98)">=</span> preferred_clock() <span style="color:rgb(98,98,98)">-</span> start

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/huggingface_hub/utils/_http.py:93</span>, in <span class="ansi-cyan-fg">UniqueRequestIdAdapter.send</span><span class="ansi-blue-fg">(self, request, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     91</span> <span style="font-style:italic;color:rgb(175,0,0)">"""Catch any RequestException to append request id to the error message for debugging."""</span>
<span class="ansi-green-fg ansi-bold">     92</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">---&gt; 93</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">super</span>()<span style="color:rgb(98,98,98)">.</span>send(request, <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">     94</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> requests<span style="color:rgb(98,98,98)">.</span>RequestException <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg ansi-bold">     95</span>     request_id <span style="color:rgb(98,98,98)">=</span> request<span style="color:rgb(98,98,98)">.</span>headers<span style="color:rgb(98,98,98)">.</span>get(X_AMZN_TRACE_ID)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/requests/adapters.py:667</span>, in <span class="ansi-cyan-fg">HTTPAdapter.send</span><span class="ansi-blue-fg">(self, request, stream, timeout, verify, cert, proxies)</span>
<span class="ansi-green-fg ansi-bold">    664</span>     timeout <span style="color:rgb(98,98,98)">=</span> TimeoutSauce(connect<span style="color:rgb(98,98,98)">=</span>timeout, read<span style="color:rgb(98,98,98)">=</span>timeout)
<span class="ansi-green-fg ansi-bold">    666</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 667</span>     resp <span style="color:rgb(98,98,98)">=</span> conn<span style="color:rgb(98,98,98)">.</span>urlopen(
<span class="ansi-green-fg ansi-bold">    668</span>         method<span style="color:rgb(98,98,98)">=</span>request<span style="color:rgb(98,98,98)">.</span>method,
<span class="ansi-green-fg ansi-bold">    669</span>         url<span style="color:rgb(98,98,98)">=</span>url,
<span class="ansi-green-fg ansi-bold">    670</span>         body<span style="color:rgb(98,98,98)">=</span>request<span style="color:rgb(98,98,98)">.</span>body,
<span class="ansi-green-fg ansi-bold">    671</span>         headers<span style="color:rgb(98,98,98)">=</span>request<span style="color:rgb(98,98,98)">.</span>headers,
<span class="ansi-green-fg ansi-bold">    672</span>         redirect<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">    673</span>         assert_same_host<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">    674</span>         preload_content<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">    675</span>         decode_content<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">    676</span>         retries<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>max_retries,
<span class="ansi-green-fg ansi-bold">    677</span>         timeout<span style="color:rgb(98,98,98)">=</span>timeout,
<span class="ansi-green-fg ansi-bold">    678</span>         chunked<span style="color:rgb(98,98,98)">=</span>chunked,
<span class="ansi-green-fg ansi-bold">    679</span>     )
<span class="ansi-green-fg ansi-bold">    681</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> (ProtocolError, <span style="font-weight:bold;color:rgb(215,95,95)">OSError</span>) <span style="font-weight:bold;color:rgb(0,135,0)">as</span> err:
<span class="ansi-green-fg ansi-bold">    682</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ConnectionError</span>(err, request<span style="color:rgb(98,98,98)">=</span>request)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/urllib3/connectionpool.py:787</span>, in <span class="ansi-cyan-fg">HTTPConnectionPool.urlopen</span><span class="ansi-blue-fg">(self, method, url, body, headers, retries, redirect, assert_same_host, timeout, pool_timeout, release_conn, chunked, body_pos, preload_content, decode_content, **response_kw)</span>
<span class="ansi-green-fg ansi-bold">    784</span> response_conn <span style="color:rgb(98,98,98)">=</span> conn <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> release_conn <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    786</span> <span style="font-style:italic;color:rgb(95,135,135)"># Make the request on the HTTPConnection object</span>
<span class="ansi-green-fg">--&gt; 787</span> response <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_make_request(
<span class="ansi-green-fg ansi-bold">    788</span>     conn,
<span class="ansi-green-fg ansi-bold">    789</span>     method,
<span class="ansi-green-fg ansi-bold">    790</span>     url,
<span class="ansi-green-fg ansi-bold">    791</span>     timeout<span style="color:rgb(98,98,98)">=</span>timeout_obj,
<span class="ansi-green-fg ansi-bold">    792</span>     body<span style="color:rgb(98,98,98)">=</span>body,
<span class="ansi-green-fg ansi-bold">    793</span>     headers<span style="color:rgb(98,98,98)">=</span>headers,
<span class="ansi-green-fg ansi-bold">    794</span>     chunked<span style="color:rgb(98,98,98)">=</span>chunked,
<span class="ansi-green-fg ansi-bold">    795</span>     retries<span style="color:rgb(98,98,98)">=</span>retries,
<span class="ansi-green-fg ansi-bold">    796</span>     response_conn<span style="color:rgb(98,98,98)">=</span>response_conn,
<span class="ansi-green-fg ansi-bold">    797</span>     preload_content<span style="color:rgb(98,98,98)">=</span>preload_content,
<span class="ansi-green-fg ansi-bold">    798</span>     decode_content<span style="color:rgb(98,98,98)">=</span>decode_content,
<span class="ansi-green-fg ansi-bold">    799</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>response_kw,
<span class="ansi-green-fg ansi-bold">    800</span> )
<span class="ansi-green-fg ansi-bold">    802</span> <span style="font-style:italic;color:rgb(95,135,135)"># Everything went great!</span>
<span class="ansi-green-fg ansi-bold">    803</span> clean_exit <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/urllib3/connectionpool.py:534</span>, in <span class="ansi-cyan-fg">HTTPConnectionPool._make_request</span><span class="ansi-blue-fg">(self, conn, method, url, body, headers, retries, timeout, chunked, response_conn, preload_content, decode_content, enforce_content_length)</span>
<span class="ansi-green-fg ansi-bold">    532</span> <span style="font-style:italic;color:rgb(95,135,135)"># Receive the response from the server</span>
<span class="ansi-green-fg ansi-bold">    533</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 534</span>     response <span style="color:rgb(98,98,98)">=</span> conn<span style="color:rgb(98,98,98)">.</span>getresponse()
<span class="ansi-green-fg ansi-bold">    535</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> (BaseSSLError, <span style="font-weight:bold;color:rgb(215,95,95)">OSError</span>) <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg ansi-bold">    536</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_raise_timeout(err<span style="color:rgb(98,98,98)">=</span>e, url<span style="color:rgb(98,98,98)">=</span>url, timeout_value<span style="color:rgb(98,98,98)">=</span>read_timeout)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/site-packages/urllib3/connection.py:516</span>, in <span class="ansi-cyan-fg">HTTPConnection.getresponse</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    513</span> _shutdown <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">getattr</span>(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>sock, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">shutdown</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>)
<span class="ansi-green-fg ansi-bold">    515</span> <span style="font-style:italic;color:rgb(95,135,135)"># Get the response from http.client.HTTPConnection</span>
<span class="ansi-green-fg">--&gt; 516</span> httplib_response <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">super</span>()<span style="color:rgb(98,98,98)">.</span>getresponse()
<span class="ansi-green-fg ansi-bold">    518</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    519</span>     assert_header_parsing(httplib_response<span style="color:rgb(98,98,98)">.</span>msg)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/http/client.py:1390</span>, in <span class="ansi-cyan-fg">HTTPConnection.getresponse</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1388</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1389</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; 1390</span>         response<span style="color:rgb(98,98,98)">.</span>begin()
<span class="ansi-green-fg ansi-bold">   1391</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">ConnectionError</span>:
<span class="ansi-green-fg ansi-bold">   1392</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>close()

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/http/client.py:325</span>, in <span class="ansi-cyan-fg">HTTPResponse.begin</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    323</span> <span style="font-style:italic;color:rgb(95,135,135)"># read until we get a non-100 response</span>
<span class="ansi-green-fg ansi-bold">    324</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>:
<span class="ansi-green-fg">--&gt; 325</span>     version, status, reason <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_read_status()
<span class="ansi-green-fg ansi-bold">    326</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> status <span style="color:rgb(98,98,98)">!=</span> CONTINUE:
<span class="ansi-green-fg ansi-bold">    327</span>         <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/http/client.py:286</span>, in <span class="ansi-cyan-fg">HTTPResponse._read_status</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    285</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">_read_status</span>(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg">--&gt; 286</span>     line <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">str</span>(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fp<span style="color:rgb(98,98,98)">.</span>readline(_MAXLINE <span style="color:rgb(98,98,98)">+</span> <span style="color:rgb(98,98,98)">1</span>), <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">iso-8859-1</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    287</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>(line) <span style="color:rgb(98,98,98)">&gt;</span> _MAXLINE:
<span class="ansi-green-fg ansi-bold">    288</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> LineTooLong(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">status line</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/socket.py:706</span>, in <span class="ansi-cyan-fg">SocketIO.readinto</span><span class="ansi-blue-fg">(self, b)</span>
<span class="ansi-green-fg ansi-bold">    704</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>:
<span class="ansi-green-fg ansi-bold">    705</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 706</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_sock<span style="color:rgb(98,98,98)">.</span>recv_into(b)
<span class="ansi-green-fg ansi-bold">    707</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> timeout:
<span class="ansi-green-fg ansi-bold">    708</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_timeout_occurred <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/ssl.py:1314</span>, in <span class="ansi-cyan-fg">SSLSocket.recv_into</span><span class="ansi-blue-fg">(self, buffer, nbytes, flags)</span>
<span class="ansi-green-fg ansi-bold">   1310</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> flags <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(98,98,98)">0</span>:
<span class="ansi-green-fg ansi-bold">   1311</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">   1312</span>           <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">non-zero flags not allowed in calls to recv_into() on </span><span style="font-weight:bold;color:rgb(175,95,135)">%s</span><span style="color:rgb(175,0,0)">"</span> <span style="color:rgb(98,98,98)">%</span>
<span class="ansi-green-fg ansi-bold">   1313</span>           <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span>)
<span class="ansi-green-fg">-&gt; 1314</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>read(nbytes, buffer)
<span class="ansi-green-fg ansi-bold">   1315</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">   1316</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">super</span>()<span style="color:rgb(98,98,98)">.</span>recv_into(buffer, nbytes, flags)

File <span class="ansi-green-fg">~/miniconda3/envs/nimrod/lib/python3.11/ssl.py:1166</span>, in <span class="ansi-cyan-fg">SSLSocket.read</span><span class="ansi-blue-fg">(self, len, buffer)</span>
<span class="ansi-green-fg ansi-bold">   1164</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1165</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> buffer <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">-&gt; 1166</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_sslobj<span style="color:rgb(98,98,98)">.</span>read(<span style="color:rgb(0,135,0)">len</span>, buffer)
<span class="ansi-green-fg ansi-bold">   1167</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">   1168</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_sslobj<span style="color:rgb(98,98,98)">.</span>read(<span style="color:rgb(0,135,0)">len</span>)

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>
</div>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> dm.train_ds[<span class="dv">0</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.shape)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>plt.imshow(x.squeeze(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1, 28, 28])</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="models.conv_files/figure-html/cell-3-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>top_kernel <span class="op">=</span> torch.tensor( <span class="co"># torch.tensor infers datatype vs. torch.Tensor</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="op">-</span><span class="fl">1.</span>, <span class="op">-</span><span class="fl">1.</span>, <span class="op">-</span><span class="fl">1.</span>],</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>     [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>     [<span class="fl">1.</span>, <span class="fl">1.</span>, <span class="fl">1.</span>]]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>bottom_kernel <span class="op">=</span> torch.tensor( <span class="co"># torch.tensor infers datatype vs. torch.Tensor</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    [[<span class="fl">1.</span>, <span class="fl">1.</span>, <span class="fl">1.</span>],</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>     [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>     [<span class="op">-</span><span class="fl">1.</span>, <span class="op">-</span><span class="fl">1.</span>, <span class="op">-</span><span class="fl">1.</span>]]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>left_kernel <span class="op">=</span> torch.tensor( <span class="co"># torch.tensor infers datatype vs. torch.Tensor</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    [[<span class="op">-</span><span class="fl">1.</span>, <span class="fl">0.</span>, <span class="fl">1.</span>],</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>     [<span class="op">-</span><span class="fl">1.</span>, <span class="fl">0.</span>, <span class="fl">1.</span>],</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>     [<span class="op">-</span><span class="fl">1.</span>, <span class="fl">0.</span>, <span class="fl">1.</span>]]</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>my_kernel <span class="op">=</span> left_kernel</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> nn.Conv2d(<span class="dv">1</span>, <span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    c.weight.copy_(my_kernel)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.shape)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> c(x)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y.shape)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>plt.imshow(y.squeeze().detach(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Convolution'</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> nn.ConvTranspose2d(<span class="dv">1</span>, <span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># with torch.no_grad():</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     dc.weight.copy_(my_kernel)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>x_bar <span class="op">=</span> dc(y)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_bar.shape)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>plt.imshow(x_bar.squeeze().detach(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Convolution transpose'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[9], line 3</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#| notest</span>
<span class="ansi-green-fg">----&gt; 3</span> my_kernel <span style="color:rgb(98,98,98)">=</span> left_kernel
<span class="ansi-green-fg ansi-bold">      5</span> c <span style="color:rgb(98,98,98)">=</span> nn<span style="color:rgb(98,98,98)">.</span>Conv2d(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>, kernel_size<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">3</span>, padding<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">1</span>, bias<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>)
<span class="ansi-green-fg ansi-bold">      6</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad():

<span class="ansi-red-fg">NameError</span>: name 'left_kernel' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="conv-block" class="level2">
<h2 class="anchored" data-anchor-id="conv-block">Conv Block</h2>
<p>Using a convolution with a stride of 2 instead of max pooling essentially achieves the same goal of downsampling an image by reducing its spatial dimensions, but with the key difference that the convolution layer can learn more complex feature combinations from overlapping regions, while max pooling only selects the maximum value within a window, potentially losing information about the finer details within that region; making the convolution with stride approach often preferred for preserving more spatial information in a neural network.</p>
<hr>
<p><a href="https://github.com/slegroux/nimrod/blob/main/nimrod/models/conv.py#L37" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="convblock" class="level3">
<h3 class="anchored" data-anchor-id="convblock">ConvBlock</h3>
<blockquote class="blockquote">
<pre><code> ConvBlock (in_channels:int=3, out_channels:int=16, kernel_size:int=3,
            stride:int=2, bias:bool=True, normalization:Optional[Type[torc
            h.nn.modules.module.Module]]=&lt;class
            'torch.nn.modules.batchnorm.BatchNorm2d'&gt;, activation:Optional
            [Type[torch.nn.modules.module.Module]]=&lt;class
            'torch.nn.modules.activation.ReLU'&gt;)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<table class="caption-top table">
<caption>ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</caption>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>in_channels</td>
<td>int</td>
<td>3</td>
<td>input channels</td>
</tr>
<tr class="even">
<td>out_channels</td>
<td>int</td>
<td>16</td>
<td>output channels</td>
</tr>
<tr class="odd">
<td>kernel_size</td>
<td>int</td>
<td>3</td>
<td>kernel size</td>
</tr>
<tr class="even">
<td>stride</td>
<td>int</td>
<td>2</td>
<td>stride</td>
</tr>
<tr class="odd">
<td>bias</td>
<td>bool</td>
<td>True</td>
<td>bias is False if BatchNorm</td>
</tr>
<tr class="even">
<td>normalization</td>
<td>Optional</td>
<td>BatchNorm2d</td>
<td>normalization</td>
</tr>
<tr class="odd">
<td>activation</td>
<td>Optional</td>
<td>ReLU</td>
<td>activation</td>
</tr>
</tbody>
</table>
</section>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">Usage</h3>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H,W)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stride 2 layer downsample to (W/2, H/2)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvBlock(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span>C,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    stride<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    bias<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    normalization<span class="op">=</span>nn.BatchNorm2d,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># get first layer of sequential and init weights</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>layer_0 <span class="op">=</span> model.net[<span class="dv">0</span>] <span class="co"># get first layer of sequential</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    model.net[<span class="dv">0</span>].weight.copy_(top_kernel)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Y: "</span>, model(X).shape)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># # flatten all dims except batch dim 1</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> torch.flatten(model(X), <span class="dv">1</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Y.shape)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>summary(model, input_size<span class="op">=</span>(B, C, H, W), depth<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[13:58:07] WARNING - setting conv bias back to False as Batchnorm is used</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Y:  torch.Size([64, 16, 14, 14])
torch.Size([64, 3136])</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
ConvBlock                                [64, 16, 14, 14]          --
├─Sequential: 1-1                        [64, 16, 14, 14]          --
│    └─Conv2d: 2-1                       [64, 16, 14, 14]          144
│    └─BatchNorm2d: 2-2                  [64, 16, 14, 14]          32
│    └─ReLU: 2-3                         [64, 16, 14, 14]          --
==========================================================================================
Total params: 176
Trainable params: 176
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 1.81
==========================================================================================
Input size (MB): 0.20
Forward/backward pass size (MB): 3.21
Params size (MB): 0.00
Estimated Total Size (MB): 3.41
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nn.Sequential(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    ConvBlock(<span class="dv">1</span>, <span class="dv">8</span>),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    ConvBlock(<span class="dv">8</span>, <span class="dv">16</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    ConvBlock(<span class="dv">16</span>, <span class="dv">32</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    ConvBlock(<span class="dv">32</span>, <span class="dv">16</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    )(X).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[13:58:09] WARNING - setting conv bias back to False as Batchnorm is used
[13:58:09] WARNING - setting conv bias back to False as Batchnorm is used
[13:58:09] WARNING - setting conv bias back to False as Batchnorm is used
[13:58:09] WARNING - setting conv bias back to False as Batchnorm is used</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([64, 16, 2, 2])</code></pre>
</div>
</div>
</section>
<section id="configs" class="level3">
<h3 class="anchored" data-anchor-id="configs">Configs</h3>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convblock.yaml'</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> instantiate(cfg.defaults)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H,W)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary(net))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Y: "</span>,net(X).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 42
[14:49:51] WARNING - setting conv bias back to False as Batchnorm is used</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
ConvBlock                                --
├─Sequential: 1-1                        --
│    └─Conv2d: 2-1                       144
│    └─BatchNorm2d: 2-2                  32
│    └─ReLU: 2-3                         --
=================================================================
Total params: 176
Trainable params: 176
Non-trainable params: 0
=================================================================
Y:  torch.Size([64, 16, 14, 14])</code></pre>
</div>
</div>
</section>
</section>
<section id="pre-activation-conv-block" class="level2">
<h2 class="anchored" data-anchor-id="pre-activation-conv-block">Pre-Activation Conv Block</h2>
<hr>
<p><a href="https://github.com/slegroux/nimrod/blob/main/nimrod/models/conv.py#L86" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="preactivationconvblock" class="level3">
<h3 class="anchored" data-anchor-id="preactivationconvblock">PreActivationConvBlock</h3>
<blockquote class="blockquote">
<pre><code> PreActivationConvBlock (in_channels:int=3, out_channels:int=16,
                         kernel_size:int=3, stride:int=2, bias:bool=True, 
                         normalization:Optional[Type[torch.nn.modules.modu
                         le.Module]]=&lt;class
                         'torch.nn.modules.batchnorm.BatchNorm2d'&gt;, activa
                         tion:Optional[Type[torch.nn.modules.module.Module
                         ]]=&lt;class 'torch.nn.modules.activation.ReLU'&gt;)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<table class="caption-top table">
<caption>ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</caption>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>in_channels</td>
<td>int</td>
<td>3</td>
<td>input channels</td>
</tr>
<tr class="even">
<td>out_channels</td>
<td>int</td>
<td>16</td>
<td>output channels</td>
</tr>
<tr class="odd">
<td>kernel_size</td>
<td>int</td>
<td>3</td>
<td>kernel size</td>
</tr>
<tr class="even">
<td>stride</td>
<td>int</td>
<td>2</td>
<td>stride</td>
</tr>
<tr class="odd">
<td>bias</td>
<td>bool</td>
<td>True</td>
<td></td>
</tr>
<tr class="even">
<td>normalization</td>
<td>Optional</td>
<td>BatchNorm2d</td>
<td></td>
</tr>
<tr class="odd">
<td>activation</td>
<td>Optional</td>
<td>ReLU</td>
<td></td>
</tr>
</tbody>
</table>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H,W)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stride 2 layer downsample to (W/2, H/2)</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> PreActivationConvBlock(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span>C,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    stride<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    bias<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    normalization<span class="op">=</span>nn.BatchNorm2d,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># get last layer of sequential and init weights</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>layer_0 <span class="op">=</span> model.net[<span class="dv">0</span>] <span class="co"># get first layer of sequential</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    model.net[<span class="op">-</span><span class="dv">1</span>].weight.copy_(top_kernel)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Y: "</span>, model(X).shape)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># # flatten all dims except batch dim 1</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> torch.flatten(model(X), <span class="dv">1</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Y.shape)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>summary(model, input_size<span class="op">=</span>(B, C, H, W), depth<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[13:58:16] WARNING - setting conv bias back to False as Batchnorm is used</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Y:  torch.Size([64, 16, 14, 14])
torch.Size([64, 3136])</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
PreActivationConvBlock                   [64, 16, 14, 14]          --
├─Sequential: 1-1                        [64, 16, 14, 14]          --
│    └─BatchNorm2d: 2-1                  [64, 1, 28, 28]           2
│    └─ReLU: 2-2                         [64, 1, 28, 28]           --
│    └─Conv2d: 2-3                       [64, 16, 14, 14]          144
==========================================================================================
Total params: 146
Trainable params: 146
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 1.81
==========================================================================================
Input size (MB): 0.20
Forward/backward pass size (MB): 2.01
Params size (MB): 0.00
Estimated Total Size (MB): 2.21
==========================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="deconv-block" class="level2">
<h2 class="anchored" data-anchor-id="deconv-block">Deconv Block</h2>
<hr>
<p><a href="https://github.com/slegroux/nimrod/blob/main/nimrod/models/conv.py#L137" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="deconvblock" class="level3">
<h3 class="anchored" data-anchor-id="deconvblock">DeconvBlock</h3>
<blockquote class="blockquote">
<pre><code> DeconvBlock (in_channels:int=16, out_channels:int=3, kernel_size:int=3,
              bias:bool=True, normalization:Optional[Type[torch.nn.modules
              .module.Module]]=None, activation:Optional[Type[torch.nn.mod
              ules.module.Module]]=&lt;class
              'torch.nn.modules.activation.ReLU'&gt;, scale_factor:int=2,
              use_transposed_conv:bool=False)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<table class="caption-top table">
<caption>ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</caption>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>in_channels</td>
<td>int</td>
<td>16</td>
<td>input channels</td>
</tr>
<tr class="even">
<td>out_channels</td>
<td>int</td>
<td>3</td>
<td>output channels</td>
</tr>
<tr class="odd">
<td>kernel_size</td>
<td>int</td>
<td>3</td>
<td>kernel size</td>
</tr>
<tr class="even">
<td>bias</td>
<td>bool</td>
<td>True</td>
<td></td>
</tr>
<tr class="odd">
<td>normalization</td>
<td>Optional</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>activation</td>
<td>Optional</td>
<td>ReLU</td>
<td></td>
</tr>
<tr class="odd">
<td>scale_factor</td>
<td>int</td>
<td>2</td>
<td></td>
</tr>
<tr class="even">
<td>use_transposed_conv</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="usage-1" class="level3">
<h3 class="anchored" data-anchor-id="usage-1">Usage</h3>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">28</span>, <span class="dv">28</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H, W)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>deconv <span class="op">=</span> DeconvBlock(<span class="dv">3</span>, <span class="dv">8</span>, scale_factor<span class="op">=</span><span class="dv">2</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, use_transposed_conv<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(deconv)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Y: "</span>,deconv(X).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DeconvBlock(
  (_net): Sequential(
    (0): ConvTranspose2d(3, 8, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), output_padding=(1, 1))
    (1): ReLU()
  )
)
Y:  torch.Size([64, 8, 56, 56])</code></pre>
</div>
</div>
</section>
</section>
<section id="conv-deconv" class="level2">
<h2 class="anchored" data-anchor-id="conv-deconv">Conv-Deconv</h2>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># one image</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> dm.train_ds[<span class="dv">0</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>C, H, W <span class="op">=</span> x.shape</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make fake batch dimension</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"x:"</span>, x.shape)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(x.squeeze(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"original image"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>my_kernel <span class="op">=</span> left_kernel</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> ConvBlock(<span class="dv">1</span>,<span class="dv">3</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    c.net[<span class="dv">0</span>].weight.copy_(my_kernel) <span class="co"># set kernel weights for convlayer 0 (actual convolution2d)</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> c(x)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"y: "</span>, y.shape)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>plt.imshow(y.detach().squeeze().numpy().transpose(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"filtered image"</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DeconvBlock(<span class="dv">3</span>, <span class="dv">1</span>, scale_factor<span class="op">=</span><span class="dv">2</span>, kernel_size<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    dc._net[<span class="dv">1</span>].weight.copy_(my_kernel) <span class="co"># set kernel weights for convlayer 1 (actual convolution2d)</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>x_bar <span class="op">=</span> dc(y)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"x_bar: "</span>, x_bar.shape)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>plt.imshow(x_bar.detach().squeeze(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Deconv image"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[14], line 4</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#| notest</span>
<span class="ansi-green-fg ansi-bold">      2</span> 
<span class="ansi-green-fg ansi-bold">      3</span> <span style="font-style:italic;color:rgb(95,135,135)"># one image</span>
<span class="ansi-green-fg">----&gt; 4</span> x, y <span style="color:rgb(98,98,98)">=</span> dm<span style="color:rgb(98,98,98)">.</span>train_ds[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg ansi-bold">      5</span> C, H, W <span style="color:rgb(98,98,98)">=</span> x<span style="color:rgb(98,98,98)">.</span>shape
<span class="ansi-green-fg ansi-bold">      6</span> <span style="font-style:italic;color:rgb(95,135,135)"># make fake batch dimension</span>

<span class="ansi-red-fg">TypeError</span>: 'NoneType' object is not subscriptable</pre>
</div>
</div>
</div>
</section>
<section id="convnet" class="level2">
<h2 class="anchored" data-anchor-id="convnet">ConvNet</h2>
<p>Simple convolution network for image recognition</p>
<hr>
<p><a href="https://github.com/slegroux/nimrod/blob/main/nimrod/models/conv.py#L187" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="convnet-1" class="level2">
<h2 class="anchored" data-anchor-id="convnet-1">ConvNet</h2>
<blockquote class="blockquote">
<pre><code> ConvNet (n_features:List[int]=[1, 8, 16, 32, 64, 128],
          num_classes:int=10, kernel_size:int=3, bias:bool=False,
          normalization:torch.nn.modules.module.Module=&lt;class
          'torch.nn.modules.batchnorm.BatchNorm2d'&gt;,
          activation:torch.nn.modules.module.Module=&lt;class
          'torch.nn.modules.activation.ReLU'&gt;)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<table class="caption-top table">
<caption>ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</caption>
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_features</td>
<td>List</td>
<td>[1, 8, 16, 32, 64, 128]</td>
<td>channel/feature expansion</td>
</tr>
<tr class="even">
<td>num_classes</td>
<td>int</td>
<td>10</td>
<td>num_classes</td>
</tr>
<tr class="odd">
<td>kernel_size</td>
<td>int</td>
<td>3</td>
<td>kernel size</td>
</tr>
<tr class="even">
<td>bias</td>
<td>bool</td>
<td>False</td>
<td>conv2d bias</td>
</tr>
<tr class="odd">
<td>normalization</td>
<td>Module</td>
<td>BatchNorm2d</td>
<td>normalization (before activation)</td>
</tr>
<tr class="even">
<td>activation</td>
<td>Module</td>
<td>ReLU</td>
<td>activation function</td>
</tr>
</tbody>
</table>
<section id="usage-2" class="level3">
<h3 class="anchored" data-anchor-id="usage-2">Usage</h3>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">64</span>, <span class="dv">64</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H, W)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>X.shape</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>n_features <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>] <span class="co">#28 14 7 4 2 1</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>n_features <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">64</span>] <span class="co">#64, 32, 16, 8, 4, 2, 1</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>convnet <span class="op">=</span> ConvNet(</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    n_features<span class="op">=</span>n_features, <span class="co"># channel/feature expansion</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span>num_classes, <span class="co"># num_classes</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    kernel_size<span class="op">=</span><span class="dv">3</span>, <span class="co"># kernel size</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    bias<span class="op">=</span><span class="va">False</span>, <span class="co"># conv2d bias</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    normalization<span class="op">=</span>nn.BatchNorm2d, <span class="co"># normalization (before activation)</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    activation<span class="op">=</span>nn.ReLU,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> convnet(X)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(out.shape)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary(convnet, input_size<span class="op">=</span>(X.shape), depth<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([64, 20])
==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
ConvNet                                  [64, 20]                  --
├─Sequential: 1-1                        [64, 20]                  --
│    └─ConvBlock: 2-1                    [64, 8, 64, 64]           232
│    └─ConvBlock: 2-2                    [64, 16, 32, 32]          1,184
│    └─ConvBlock: 2-3                    [64, 32, 16, 16]          4,672
│    └─ConvBlock: 2-4                    [64, 64, 8, 8]            18,560
│    └─ConvBlock: 2-5                    [64, 128, 4, 4]           73,984
│    └─ConvBlock: 2-6                    [64, 64, 2, 2]            73,856
│    └─ConvBlock: 2-7                    [64, 20, 1, 1]            11,560
│    └─Flatten: 2-8                      [64, 20]                  --
==========================================================================================
Total params: 184,048
Trainable params: 184,048
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 378.27
==========================================================================================
Input size (MB): 3.15
Forward/backward pass size (MB): 65.29
Params size (MB): 0.74
Estimated Total Size (MB): 69.18
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from config</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnet.yaml'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print(cfg.defaults)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># convnet = instantiate(cfg.defaults)</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cfg.batchnorm)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>convnet <span class="op">=</span> instantiate(cfg.baseline)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># print(convnet(X).shape)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'_target_': 'nimrod.models.conv.ConvNet', 'n_features': [1, 8, 16, 32, 64, 128], 'num_classes': 10, 'kernel_size': 3, 'bias': False, 'normalization': {'_target_': 'hydra.utils.get_class', 'path': 'torch.nn.BatchNorm2d'}, 'activation': {'_target_': 'hydra.utils.get_class', 'path': 'torch.nn.ReLU'}}</code></pre>
</div>
</div>
</section>
<section id="training" class="level3">
<h3 class="anchored" data-anchor-id="training">Training</h3>
<section id="dataloaders" class="level4">
<h4 class="anchored" data-anchor-id="dataloaders">Dataloaders</h4>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data module config</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/data/image/fashion_mnist.yaml'</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> instantiate(cfg, batch_size<span class="op">=</span>BATCH_SIZE)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>datamodule.prepare_data()</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>datamodule.setup()</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># one data point </span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>X,y <span class="op">=</span> datamodule.test_ds[<span class="dv">0</span>]</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"X (C,H,W): "</span>, X.shape, <span class="st">"y: "</span>, y)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co"># a batch of data via dataloader</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>XX,YY <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(datamodule.test_dataloader()))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"XX (B,C,H,W): "</span>, XX.shape, <span class="st">"YY: "</span>, YY.shape)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(datamodule.train_ds))</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(datamodule.train_ds) <span class="op">//</span> BATCH_SIZE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[16:28:58] INFO - Init ImageDataModule for fashion_mnist
[16:29:17] INFO - split train into train/val [0.8, 0.2]
[16:29:17] INFO - train: 48000 val: 12000, test: 10000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>X (C,H,W):  torch.Size([1, 32, 32]) y:  9
XX (B,C,H,W):  torch.Size([512, 1, 32, 32]) YY:  torch.Size([512])
48000
93</code></pre>
</div>
</div>
</section>
<section id="model-hardware" class="level4">
<h4 class="anchored" data-anchor-id="model-hardware">Model &amp; hardware</h4>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> get_device()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnet.yaml'</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print(cfg.defaults)</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convnet = instantiate(cfg.defaults)</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cfg.baseline)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>convnet <span class="op">=</span> instantiate(cfg.baseline)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> convnet.to(device)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>summary(model, input_size<span class="op">=</span>(B, C, H, W), depth<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[16:29:17] INFO - Using device: mps</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>mps
{'_target_': 'nimrod.models.conv.ConvNet', 'n_features': [1, 8, 16, 32, 64], 'num_classes': 10, 'kernel_size': 3, 'bias': True, 'normalization': None, 'activation': {'_target_': 'hydra.utils.get_class', 'path': 'torch.nn.ReLU'}}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
ConvNet                                  [64, 40]                  --
├─Sequential: 1-1                        [64, 40]                  --
│    └─ConvLayer: 2-1                    [64, 8, 28, 28]           --
│    │    └─Sequential: 3-1              [64, 8, 28, 28]           --
│    │    │    └─Conv2d: 4-1             [64, 8, 28, 28]           80
│    │    │    └─ReLU: 4-2               [64, 8, 28, 28]           --
│    └─ConvLayer: 2-2                    [64, 16, 14, 14]          --
│    │    └─Sequential: 3-2              [64, 16, 14, 14]          --
│    │    │    └─Conv2d: 4-3             [64, 16, 14, 14]          1,168
│    │    │    └─ReLU: 4-4               [64, 16, 14, 14]          --
│    └─ConvLayer: 2-3                    [64, 32, 7, 7]            --
│    │    └─Sequential: 3-3              [64, 32, 7, 7]            --
│    │    │    └─Conv2d: 4-5             [64, 32, 7, 7]            4,640
│    │    │    └─ReLU: 4-6               [64, 32, 7, 7]            --
│    └─ConvLayer: 2-4                    [64, 64, 4, 4]            --
│    │    └─Sequential: 3-4              [64, 64, 4, 4]            --
│    │    │    └─Conv2d: 4-7             [64, 64, 4, 4]            18,496
│    │    │    └─ReLU: 4-8               [64, 64, 4, 4]            --
│    └─ConvLayer: 2-5                    [64, 10, 2, 2]            --
│    │    └─Sequential: 3-5              [64, 10, 2, 2]            --
│    │    │    └─Conv2d: 4-9             [64, 10, 2, 2]            5,770
│    └─Flatten: 2-6                      [64, 40]                  --
==========================================================================================
Total params: 30,154
Trainable params: 30,154
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 53.63
==========================================================================================
Input size (MB): 0.20
Forward/backward pass size (MB): 6.16
Params size (MB): 0.12
Estimated Total Size (MB): 6.49
==========================================================================================</code></pre>
</div>
</div>
</section>
<section id="lr-finder" class="level4">
<h4 class="anchored" data-anchor-id="lr-finder">LR finder</h4>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnet.yaml'</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> instantiate(cfg.batchnorm)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary(model, depth<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.CrossEntropyLoss()    </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>) <span class="co">#, weight_decay=1e-5)</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize LR Finder</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>lr_finder <span class="op">=</span> LRFinder(model, optimizer, criterion, device<span class="op">=</span>device)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run LR range test</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>lr_finder.range_test(</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    datamodule.train_dataloader(),</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    start_lr<span class="op">=</span><span class="fl">1e-5</span>,      <span class="co"># Extremely small starting learning rate</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    end_lr<span class="op">=</span><span class="dv">10</span>,          <span class="co"># Large ending learning rate</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    num_iter<span class="op">=</span><span class="dv">100</span>,   <span class="co"># Number of iterations to test</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    smooth_f<span class="op">=</span><span class="fl">0.05</span>,   <span class="co"># Smoothing factor for the loss</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    diverge_th<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the learning rate vs loss</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>_, lr_found <span class="op">=</span> lr_finder.plot(log_lr<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Suggested lr:'</span>, lr_found)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>lr_finder.reset()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
ConvNet                                  --
├─Sequential: 1-1                        --
│    └─ConvLayer: 2-1                    --
│    │    └─Sequential: 3-1              --
│    │    │    └─Conv2d: 4-1             72
│    │    │    └─BatchNorm2d: 4-2        16
│    │    │    └─ReLU: 4-3               --
│    └─ConvLayer: 2-2                    --
│    │    └─Sequential: 3-2              --
│    │    │    └─Conv2d: 4-4             1,152
│    │    │    └─BatchNorm2d: 4-5        32
│    │    │    └─ReLU: 4-6               --
│    └─ConvLayer: 2-3                    --
│    │    └─Sequential: 3-3              --
│    │    │    └─Conv2d: 4-7             4,608
│    │    │    └─BatchNorm2d: 4-8        64
│    │    │    └─ReLU: 4-9               --
│    └─ConvLayer: 2-4                    --
│    │    └─Sequential: 3-4              --
│    │    │    └─Conv2d: 4-10            18,432
│    │    │    └─BatchNorm2d: 4-11       128
│    │    │    └─ReLU: 4-12              --
│    └─ConvLayer: 2-5                    --
│    │    └─Sequential: 3-5              --
│    │    │    └─Conv2d: 4-13            73,728
│    │    │    └─BatchNorm2d: 4-14       256
│    │    │    └─ReLU: 4-15              --
│    └─ConvLayer: 2-6                    --
│    │    └─Sequential: 3-6              --
│    │    │    └─Conv2d: 4-16            11,530
│    └─Flatten: 2-7                      --
=================================================================
Total params: 110,018
Trainable params: 110,018
Non-trainable params: 0
=================================================================</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fc70a3a60d7f4ce288aa2e5958fa105c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Stopping early, the loss has diverged
Learning rate search finished. See the graph with {finder_name}.plot()
LR suggestion: steepest gradient
Suggested LR: 2.01E-03</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="models.conv_files/figure-html/cell-20-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Suggested lr: 0.0020092330025650463</code></pre>
</div>
</div>
</section>
<section id="cycle-warm-up" class="level4">
<h4 class="anchored" data-anchor-id="cycle-warm-up">1-cycle warm-up</h4>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> get_device()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># data module config</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>cfg_dm <span class="op">=</span> OmegaConf.load(<span class="st">'../config/data/image/fashion_mnist.yaml'</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>cfg_dm.batch_size <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> instantiate(cfg_dm)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>datamodule.prepare_data()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>datamodule.setup()</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># device = 'cpu'</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>cfg_mdl <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnet.yaml'</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>convnet <span class="op">=</span> instantiate(cfg_mdl.batchnorm)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> convnet.to(device)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>N_EPOCHS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>lr_found <span class="op">=</span> <span class="fl">3e-4</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>steps_per_epoch <span class="op">=</span> <span class="bu">len</span>(datamodule.train_ds) <span class="op">//</span> cfg_dm.batch_size</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>total_steps <span class="op">=</span> steps_per_epoch<span class="op">*</span> N_EPOCHS</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"size training set: </span><span class="sc">{</span><span class="bu">len</span>(datamodule.train_ds)<span class="sc">}</span><span class="ss">, bs: </span><span class="sc">{</span>cfg_dm<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">, steps/epoch: </span><span class="sc">{</span>steps_per_epoch<span class="sc">}</span><span class="ss">, total steps: </span><span class="sc">{</span>total_steps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co"># scheduler = torch.optim.lr_scheduler.OneCycleLR(optimizer, max_lr=0.01, steps_per_epoch=steps_per_epochs, epochs=1)</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>scheduler <span class="op">=</span> torch.optim.lr_scheduler.OneCycleLR(</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        optimizer,</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>        max_lr<span class="op">=</span>lr_found,  <span class="co"># Peak learning rate</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># total_steps=len(datamodule.train_ds) * N_EPOCHS,  # Total training iterations</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>        steps_per_epoch<span class="op">=</span>steps_per_epoch,</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>N_EPOCHS,</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>        pct_start<span class="op">=</span><span class="fl">0.3</span>,  <span class="co"># 30% of training increasing LR, 70% decreasing</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        anneal_strategy<span class="op">=</span><span class="st">'cos'</span>,  <span class="co"># Cosine annealing</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>        div_factor<span class="op">=</span><span class="dv">10</span>,  <span class="co"># Initial lr = max_lr / div_factor</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># final_div_factor=1e4,</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>        three_phase<span class="op">=</span><span class="va">False</span>  <span class="co"># Two phase LR schedule (increase then decrease)</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="co">################################</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>lrs <span class="op">=</span> []</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>current_step <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>train_loss_history <span class="op">=</span> []</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>eval_loss_history <span class="op">=</span> []</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>avg_train_loss_hist <span class="op">=</span> []</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>avg_eval_loss_hist <span class="op">=</span> []</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>max_acc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(N_EPOCHS):</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> images, labels <span class="kw">in</span> datamodule.train_dataloader():</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_step <span class="op">&gt;=</span> total_steps:</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Reached total steps: </span><span class="sc">{</span>current_step<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_steps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>        images, labels <span class="op">=</span> images.to(device), labels.to(device)</span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> criterion(outputs, labels)        </span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        scheduler.step()    </span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>        current_step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>        train_loss_history.append(loss.item())</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># current_lr = scheduler.get_last_lr()[0]</span></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>        current_lr <span class="op">=</span> optimizer.param_groups[<span class="dv">0</span>][<span class="st">'lr'</span>]</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>        lrs.append(current_lr)</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> (i <span class="op">%</span> <span class="dv">100</span>):</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Loss </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">, Current LR: </span><span class="sc">{</span>current_lr<span class="sc">:.10f}</span><span class="ss">, Step: </span><span class="sc">{</span>current_step<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_steps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, labels <span class="kw">in</span> datamodule.val_dataloader():</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># model expects input (B,H*W)</span></span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> images.to(device)</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> labels.to(device)</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Pass the input through the model</span></span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># eval loss</span></span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>            eval_loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>            eval_loss_history.append(eval_loss.item())</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the predicted labels</span></span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(outputs.data, <span class="dv">1</span>)</span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the total and correct counts</span></span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> labels.size(<span class="dv">0</span>)</span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> (predicted <span class="op">==</span> labels).<span class="bu">sum</span>()</span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>            acc <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> correct <span class="op">/</span> total</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> acc <span class="op">&gt;</span> max_acc:</span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>                max_acc <span class="op">=</span> acc</span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the accuracy</span></span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: Last training Loss </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">, Last Eval loss </span><span class="sc">{</span>eval_loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss"> Accuracy = </span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> correct <span class="op">/</span> total<span class="sc">:.2f}</span><span class="ss">% Best Accuracy: </span><span class="sc">{</span>max_acc<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f'Current LR: {optimizer.param_groups[0]["lr"]:.5f}')</span></span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="dv">1</span>)</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">211</span>)</span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'loss'</span>)</span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'step'</span>)</span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>plt.plot(train_loss_history)</span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a>plt.plot(eval_loss_history)</span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">212</span>)</span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'lr'</span>)</span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'step'</span>)</span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a>plt.plot(lrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 42
Seed set to 42
[23:31:47] INFO - Init ImageDataModule for fashion_mnist
[23:31:52] INFO - loading dataset fashion_mnist with args () from split train
[23:32:00] INFO - loading dataset fashion_mnist with args () from split test
[23:32:03] INFO - split train into train/val [0.8, 0.2]
[23:32:03] INFO - train: 48000 val: 12000, test: 10000</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[9], line 11</span>
<span class="ansi-green-fg ansi-bold">      8</span> datamodule<span style="color:rgb(98,98,98)">.</span>setup()
<span class="ansi-green-fg ansi-bold">     10</span> <span style="font-style:italic;color:rgb(95,135,135)"># device = 'cpu'</span>
<span class="ansi-green-fg">---&gt; 11</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-bg">device</span>)
<span class="ansi-green-fg ansi-bold">     12</span> cfg_mdl <span style="color:rgb(98,98,98)">=</span> OmegaConf<span style="color:rgb(98,98,98)">.</span>load(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">../config/model/image/convnet.yaml</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">     13</span> convnet <span style="color:rgb(98,98,98)">=</span> instantiate(cfg_mdl<span style="color:rgb(98,98,98)">.</span>batchnorm)

<span class="ansi-red-fg">NameError</span>: name 'device' is not defined</pre>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="convnetx" class="level2">
<h2 class="anchored" data-anchor-id="convnetx">ConvNetX</h2>
<hr>
<p><a href="https://github.com/slegroux/nimrod/blob/main/nimrod/models/conv.py#L222" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="convnetx-1" class="level3">
<h3 class="anchored" data-anchor-id="convnetx-1">ConvNetX</h3>
<blockquote class="blockquote">
<pre><code> ConvNetX (nnet:__main__.ConvNet, num_classes:int,
           optimizer:Callable[...,torch.optim.optimizer.Optimizer],
           scheduler:Optional[Callable[...,Any]]=None)</code></pre>
</blockquote>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>nnet</td>
<td>ConvNet</td>
<td></td>
<td>model</td>
</tr>
<tr class="even">
<td>num_classes</td>
<td>int</td>
<td></td>
<td>number of classes</td>
</tr>
<tr class="odd">
<td>optimizer</td>
<td>Callable</td>
<td></td>
<td>optimizer</td>
</tr>
<tr class="even">
<td>scheduler</td>
<td>Optional</td>
<td>None</td>
<td>scheduler</td>
</tr>
</tbody>
</table>
</section>
<section id="usage-3" class="level3">
<h3 class="anchored" data-anchor-id="usage-3">Usage</h3>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnetx.yaml'</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>feats_dim <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">64</span>]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>cfg.nnet.n_features <span class="op">=</span> feats_dim</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>cfg.nnet.num_classes <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> instantiate(cfg.nnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">64</span>, <span class="dv">64</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(B, C, H, W)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>X.shape</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model(X).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([64, 200])</code></pre>
</div>
</div>
<div id="cell-42" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>summary(model, input_size<span class="op">=</span>(B, C, H, W), depth<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
ConvNet                                  [64, 200]                 --
├─Sequential: 1-1                        [64, 200]                 --
│    └─ConvBlock: 2-1                    [64, 8, 64, 64]           232
│    └─ConvBlock: 2-2                    [64, 16, 32, 32]          1,184
│    └─ConvBlock: 2-3                    [64, 32, 16, 16]          4,672
│    └─ConvBlock: 2-4                    [64, 64, 8, 8]            18,560
│    └─ConvBlock: 2-5                    [64, 128, 4, 4]           73,984
│    └─ConvBlock: 2-6                    [64, 64, 2, 2]            73,856
│    └─ConvBlock: 2-7                    [64, 200, 1, 1]           115,600
│    └─Flatten: 2-8                      [64, 200]                 --
==========================================================================================
Total params: 288,088
Trainable params: 288,088
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 384.93
==========================================================================================
Input size (MB): 3.15
Forward/backward pass size (MB): 65.48
Params size (MB): 1.15
Estimated Total Size (MB): 69.78
==========================================================================================</code></pre>
</div>
</div>
</section>
<section id="nimrod-training" class="level3">
<h3 class="anchored" data-anchor-id="nimrod-training">Nimrod training</h3>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>N_EPOCHS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data module config</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/data/image/fashion_mnist.yaml'</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>cfg.batch_size <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>cfg.num_workers <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> instantiate(cfg)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>datamodule.prepare_data()</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>datamodule.setup()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[20:23:50] INFO - Init ImageDataModule for fashion_mnist
[20:24:08] INFO - split train into train/val [0.8, 0.2]
[20:24:08] INFO - train: 48000 val: 12000, test: 10000</code></pre>
</div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/optimizer/adam_w.yaml'</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> instantiate(cfg)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/scheduler/step_lr.yaml'</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>scheduler <span class="op">=</span> instantiate(cfg)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnetx.yaml'</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> instantiate(cfg)(optimizer<span class="op">=</span>optimizer, scheduler<span class="op">=</span>scheduler)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co"># # with 1-cycle sched</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cfg.nnet.n_features = [1, 8, 16, 32, 64, 128]</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># cfg.scheduler.total_steps = len(datamodule.train_ds) * N_EPOCHS</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co"># model = instantiate(cfg)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[14:53:05] INFO - ConvNetX: init
[14:53:05] INFO - Classifier: init
/user/s/slegroux/miniconda3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/utilities/parsing.py:209: Attribute 'nnet' is an instance of `nn.Module` and is already saved during checkpointing. It is recommended to ignore them using `self.save_hyperparameters(ignore=['nnet'])`.</code></pre>
</div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span>N_EPOCHS,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">=</span>TensorBoardLogger(<span class="st">"tb_logs"</span>, name<span class="op">=</span><span class="st">"fashion_mnist_convnet"</span>, default_hp_metric<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logger=CSVLogger("logs", name="mnist_convnet"),</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"step"</span>)],</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    check_val_every_n_epoch<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">1</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (mps), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs</code></pre>
</div>
</div>
<section id="lr-finder-1" class="level4">
<h4 class="anchored" data-anchor-id="lr-finder-1">LR finder</h4>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> Tuner(trainer)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>lr_finder <span class="op">=</span> tuner.lr_find(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    datamodule<span class="op">=</span>datamodule,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    min_lr<span class="op">=</span><span class="fl">1e-5</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    max_lr<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    num_training<span class="op">=</span><span class="dv">100</span>,  <span class="co"># number of iterations</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># attr_name="optimizer.lr",</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> lr_finder.plot(suggest<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Suggested learning rate: </span><span class="sc">{</span>lr_finder<span class="sc">.</span>suggestion()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[20:59:14] INFO - Optimizer: &lt;class 'torch.optim.adamw.AdamW'&gt;
[20:59:14] INFO - Scheduler: &lt;torch.optim.lr_scheduler.StepLR object&gt;
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'val_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8a0753b0871049089cba4cdb7e336629","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`Trainer.fit` stopped: `max_steps=100` reached.
Learning rate set to 0.0019952623149688807
Restoring states from the checkpoint path at /Users/slegroux/Projects/nimrod/nbs/.lr_find_61a6646e-2298-4940-9b72-9185e67e8d21.ckpt
Restored all states from the checkpoint at /Users/slegroux/Projects/nimrod/nbs/.lr_find_61a6646e-2298-4940-9b72-9185e67e8d21.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="models.conv_files/figure-html/cell-29-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Suggested learning rate: 0.0019952623149688807</code></pre>
</div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(trainer.max_epochs, <span class="bu">len</span>(datamodule.train_ds), datamodule.hparams.batch_size)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="dv">5</span><span class="op">*</span><span class="dv">56000</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="dv">5</span><span class="op">*</span><span class="dv">56000</span><span class="op">/</span><span class="dv">2048</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="dv">5</span><span class="op">*</span><span class="dv">56000</span><span class="op">//</span><span class="dv">2048</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10 48000 512
280000
136.71875
136</code></pre>
</div>
</div>
</section>
<section id="cycle-scheduling" class="level4">
<h4 class="anchored" data-anchor-id="cycle-scheduling">1-cycle scheduling</h4>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>N_EPOCHS <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lr_found = lr_finder.suggestion()</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>lr_found <span class="op">=</span> <span class="fl">3e-4</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/data/image/mnist.yaml'</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>cfg.batch_size <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>cfg.num_workers <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> instantiate(cfg)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>datamodule.prepare_data()</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>datamodule.setup()</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>checkpoint_callback <span class="op">=</span> ModelCheckpoint(</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span><span class="st">'val/loss'</span>,  <span class="co"># Metric to monitor</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    dirpath<span class="op">=</span><span class="st">'checkpoints/'</span>,  <span class="co"># Directory to save checkpoints</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">=</span><span class="st">'epoch</span><span class="sc">{epoch:02d}</span><span class="st">-val_loss{val/loss:.2f}'</span>,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>    auto_insert_metric_name<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    save_top_k<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Save only the best checkpoint</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'min'</span>  <span class="co"># Mode can be 'min' or 'max' depending on the metric</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>lr_monitor <span class="op">=</span> LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"step"</span>)</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a><span class="co"># TRAINER </span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span>N_EPOCHS,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logger=TensorBoardLogger("tb_logs", name="mnist_convnet", default_hp_metric=True),</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">=</span>CSVLogger(<span class="st">"logs"</span>, name<span class="op">=</span><span class="st">"fashion_mnist_convnet"</span>),</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [lr_monitor, checkpoint_callback],</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>    check_val_every_n_epoch<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">1</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"estimated steps: "</span>, trainer.estimated_stepping_batches, <span class="st">"accumulate_grad_batches: "</span>, trainer.accumulate_grad_batches)</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a><span class="co"># MODEL</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>model_cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/model/image/convnetx.yaml'</span>)</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>model_cfg.scheduler.total_steps <span class="op">=</span> trainer.max_epochs <span class="op">*</span> <span class="bu">len</span>(datamodule.train_dataloader())</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>model_cfg.scheduler.max_lr <span class="op">=</span> lr_found<span class="co">#lr_finder.suggestion()</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> instantiate(model_cfg)</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"LR: "</span>,model.lr)</span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>trainer.fit(model, datamodule.train_dataloader(), datamodule.val_dataloader())</span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a><span class="co">########################</span></span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a>csv_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trainer<span class="sc">.</span>logger<span class="sc">.</span>log_dir<span class="sc">}</span><span class="ss">/metrics.csv"</span></span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> pd.read_csv(csv_path)</span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a>metrics.head()</span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true" tabindex="-1"></a><span class="co">##########################</span></span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'train/loss_step'</span>], <span class="st">'b.-'</span>)</span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'val/loss'</span>],<span class="st">'r.-'</span>)</span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'lr-AdamW'</span>], <span class="st">'g.-'</span>)</span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[23:33:22] INFO - Init ImageDataModule for mnist
[23:33:26] INFO - loading dataset mnist with args () from split train
[23:33:33] INFO - loading dataset mnist with args () from split test
[23:33:36] INFO - split train into train/val [0.8, 0.2]
[23:33:36] INFO - train: 48000 val: 12000, test: 10000
GPU available: True (mps), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
Loading `train_dataloader` to estimate number of stepping batches.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>estimated steps:  -1 accumulate_grad_batches:  1</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ConfigAttributeError</span>                      Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[10], line 41</span>
<span class="ansi-green-fg ansi-bold">     39</span> <span style="font-style:italic;color:rgb(95,135,135)"># MODEL</span>
<span class="ansi-green-fg ansi-bold">     40</span> model_cfg <span style="color:rgb(98,98,98)">=</span> OmegaConf<span style="color:rgb(98,98,98)">.</span>load(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">../config/model/image/convnetx.yaml</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg">---&gt; 41</span> <span class="ansi-yellow-bg">model_cfg</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">scheduler</span><span style="color:rgb(98,98,98)">.</span>total_steps <span style="color:rgb(98,98,98)">=</span> trainer<span style="color:rgb(98,98,98)">.</span>max_epochs <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(0,135,0)">len</span>(datamodule<span style="color:rgb(98,98,98)">.</span>train_dataloader())
<span class="ansi-green-fg ansi-bold">     42</span> model_cfg<span style="color:rgb(98,98,98)">.</span>scheduler<span style="color:rgb(98,98,98)">.</span>max_lr <span style="color:rgb(98,98,98)">=</span> lr_found<span style="font-style:italic;color:rgb(95,135,135)">#lr_finder.suggestion()</span>
<span class="ansi-green-fg ansi-bold">     44</span> model <span style="color:rgb(98,98,98)">=</span> instantiate(model_cfg)

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/dictconfig.py:355</span>, in <span class="ansi-cyan-fg">DictConfig.__getattr__</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg ansi-bold">    351</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_get_impl(
<span class="ansi-green-fg ansi-bold">    352</span>         key<span style="color:rgb(98,98,98)">=</span>key, default_value<span style="color:rgb(98,98,98)">=</span>_DEFAULT_MARKER_, validate_key<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg ansi-bold">    353</span>     )
<span class="ansi-green-fg ansi-bold">    354</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> ConfigKeyError <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg">--&gt; 355</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_format_and_raise</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    356</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">value</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">cause</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">e</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">type_override</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ConfigAttributeError</span>
<span class="ansi-green-fg ansi-bold">    357</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    358</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg ansi-bold">    359</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_format_and_raise(key<span style="color:rgb(98,98,98)">=</span>key, value<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, cause<span style="color:rgb(98,98,98)">=</span>e)

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/base.py:231</span>, in <span class="ansi-cyan-fg">Node._format_and_raise</span><span class="ansi-blue-fg">(self, key, value, cause, msg, type_override)</span>
<span class="ansi-green-fg ansi-bold">    223</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">_format_and_raise</span>(
<span class="ansi-green-fg ansi-bold">    224</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    225</span>     key: Any,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    229</span>     type_override: Any <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    230</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 231</span>     <span class="ansi-yellow-bg">format_and_raise</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    232</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">node</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    233</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    234</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">value</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">value</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    235</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">msg</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">str</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">cause</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">if</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">msg</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">is</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">else</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">msg</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    236</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">cause</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">cause</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    237</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">type_override</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">type_override</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    239</span>     <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/_utils.py:899</span>, in <span class="ansi-cyan-fg">format_and_raise</span><span class="ansi-blue-fg">(node, key, value, msg, cause, type_override)</span>
<span class="ansi-green-fg ansi-bold">    896</span>     ex<span style="color:rgb(98,98,98)">.</span>ref_type <span style="color:rgb(98,98,98)">=</span> ref_type
<span class="ansi-green-fg ansi-bold">    897</span>     ex<span style="color:rgb(98,98,98)">.</span>ref_type_str <span style="color:rgb(98,98,98)">=</span> ref_type_str
<span class="ansi-green-fg">--&gt; 899</span> <span class="ansi-yellow-bg">_raise</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">ex</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">cause</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/_utils.py:797</span>, in <span class="ansi-cyan-fg">_raise</span><span class="ansi-blue-fg">(ex, cause)</span>
<span class="ansi-green-fg ansi-bold">    795</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    796</span>     ex<span style="color:rgb(98,98,98)">.</span>__cause__ <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 797</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> ex<span style="color:rgb(98,98,98)">.</span>with_traceback(sys<span style="color:rgb(98,98,98)">.</span>exc_info()[<span style="color:rgb(98,98,98)">2</span>])

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/dictconfig.py:351</span>, in <span class="ansi-cyan-fg">DictConfig.__getattr__</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg ansi-bold">    348</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">AttributeError</span>()
<span class="ansi-green-fg ansi-bold">    350</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 351</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_get_impl</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    352</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">default_value</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_DEFAULT_MARKER_</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">validate_key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span>
<span class="ansi-green-fg ansi-bold">    353</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    354</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> ConfigKeyError <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg ansi-bold">    355</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_format_and_raise(
<span class="ansi-green-fg ansi-bold">    356</span>         key<span style="color:rgb(98,98,98)">=</span>key, value<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, cause<span style="color:rgb(98,98,98)">=</span>e, type_override<span style="color:rgb(98,98,98)">=</span>ConfigAttributeError
<span class="ansi-green-fg ansi-bold">    357</span>     )

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/dictconfig.py:442</span>, in <span class="ansi-cyan-fg">DictConfig._get_impl</span><span class="ansi-blue-fg">(self, key, default_value, validate_key)</span>
<span class="ansi-green-fg ansi-bold">    438</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">_get_impl</span>(
<span class="ansi-green-fg ansi-bold">    439</span>     <span style="color:rgb(0,135,0)">self</span>, key: DictKeyType, default_value: Any, validate_key: <span style="color:rgb(0,135,0)">bool</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg ansi-bold">    440</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Any:
<span class="ansi-green-fg ansi-bold">    441</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 442</span>         node <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_get_child</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    443</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">throw_on_missing_key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">validate_key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">validate_key</span>
<span class="ansi-green-fg ansi-bold">    444</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    445</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> (ConfigAttributeError, ConfigKeyError):
<span class="ansi-green-fg ansi-bold">    446</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> default_value <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> _DEFAULT_MARKER_:

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/basecontainer.py:73</span>, in <span class="ansi-cyan-fg">BaseContainer._get_child</span><span class="ansi-blue-fg">(self, key, validate_access, validate_key, throw_on_missing_value, throw_on_missing_key)</span>
<span class="ansi-green-fg ansi-bold">     64</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">_get_child</span>(
<span class="ansi-green-fg ansi-bold">     65</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">     66</span>     key: Any,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     70</span>     throw_on_missing_key: <span style="color:rgb(0,135,0)">bool</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">     71</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Union[Optional[Node], List[Optional[Node]]]:
<span class="ansi-green-fg ansi-bold">     72</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""Like _get_node, passing through to the nearest concrete Node."""</span>
<span class="ansi-green-fg">---&gt; 73</span>     child <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_get_node</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">     74</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">     75</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">validate_access</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">validate_access</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">     76</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">validate_key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">validate_key</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">     77</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">throw_on_missing_value</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">throw_on_missing_value</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">     78</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">throw_on_missing_key</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">throw_on_missing_key</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">     79</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     80</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(child, UnionNode) <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> _is_special(child):
<span class="ansi-green-fg ansi-bold">     81</span>         value <span style="color:rgb(98,98,98)">=</span> child<span style="color:rgb(98,98,98)">.</span>_value()

File <span class="ansi-green-fg">~/miniforge3/envs/nimrod/lib/python3.11/site-packages/omegaconf/dictconfig.py:480</span>, in <span class="ansi-cyan-fg">DictConfig._get_node</span><span class="ansi-blue-fg">(self, key, validate_access, validate_key, throw_on_missing_value, throw_on_missing_key)</span>
<span class="ansi-green-fg ansi-bold">    478</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> value <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    479</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> throw_on_missing_key:
<span class="ansi-green-fg">--&gt; 480</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> ConfigKeyError(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Missing key </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>key<span style="font-weight:bold;color:rgb(175,95,135)">!s}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    481</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> throw_on_missing_value <span style="font-weight:bold;color:rgb(175,0,255)">and</span> value<span style="color:rgb(98,98,98)">.</span>_is_missing():
<span class="ansi-green-fg ansi-bold">    482</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> MissingMandatoryValue(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Missing mandatory value: $KEY</span><span style="color:rgb(175,0,0)">"</span>)

<span class="ansi-red-fg">ConfigAttributeError</span>: Missing key scheduler
    full_key: scheduler
    object_type=dict</pre>
</div>
</div>
</div>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>trainer.test(model, datamodule.test_dataloader(), ckpt_path<span class="op">=</span><span class="st">"best"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Restoring states from the checkpoint path at /Users/slegroux/Projects/nimrod/nbs/checkpoints/epoch00-val_loss0.13.ckpt
Loaded model weights from the checkpoint at /Users/slegroux/Projects/nimrod/nbs/checkpoints/epoch00-val_loss0.13.ckpt
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'test_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b0f99754f03a4a02852ee7f99715e672","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test/acc          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9707000255584717     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test/loss         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.11260439455509186    </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[{'test/loss': 0.11260439455509186, 'test/acc': 0.9707000255584717}]</code></pre>
</div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>best_checkpoint_path <span class="op">=</span> checkpoint_callback.best_model_path</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best checkpoint path: </span><span class="sc">{</span>best_checkpoint_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best checkpoint path: /Users/slegroux/Projects/nimrod/nbs/checkpoints/epoch00-val_loss0.13.ckpt</code></pre>
</div>
</div>
</section>
<section id="resume-training" class="level4">
<h4 class="anchored" data-anchor-id="resume-training">Resume training</h4>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> OmegaConf.load(<span class="st">'../config/scheduler/reduce_lr_on_plateau.yaml'</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> instantiate(cfg)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sched.total_steps = len(datamodule.train_ds) * N_EPOCHS</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> trainer.optimizers[<span class="dv">0</span>].param_groups[<span class="dv">0</span>][<span class="st">'lr'</span>]</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"LR: </span><span class="sc">{</span>lr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvNetX.load_from_checkpoint(best_checkpoint_path,scheduler<span class="op">=</span>sched, lr<span class="op">=</span>lr)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>pprint(model.hparams)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[20:56:41] INFO - ConvNetX: init
[20:56:41] INFO - Classifier: init</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>LR: 7.642883799445691e-07
"nnet":        ConvNet(
  (net): Sequential(
    (0): ConvLayer(
      (net): Sequential(
        (0): Conv2d(1, 8, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(8, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
    )
    (1): ConvLayer(
      (net): Sequential(
        (0): Conv2d(8, 16, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
    )
    (2): ConvLayer(
      (net): Sequential(
        (0): Conv2d(16, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
    )
    (3): ConvLayer(
      (net): Sequential(
        (0): Conv2d(32, 64, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
    )
    (4): ConvLayer(
      (net): Sequential(
        (0): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
    )
    (5): ConvLayer(
      (net): Sequential(
        (0): Conv2d(128, 10, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
      )
    )
    (6): Flatten(start_dim=1, end_dim=-1)
  )
)
"num_classes": 10
"optimizer":   functools.partial(&lt;class 'torch.optim.adamw.AdamW'&gt;, lr=0.0001, weight_decay=1e-05)
"scheduler":   functools.partial(&lt;class 'torch.optim.lr_scheduler.ReduceLROnPlateau'&gt;, mode='min', factor=0.1, patience=10)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/utilities/parsing.py:208: Attribute 'nnet' is an instance of `nn.Module` and is already saved during checkpointing. It is recommended to ignore them using `self.save_hyperparameters(ignore=['nnet'])`.</code></pre>
</div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># batchnorm should allow us to try higher LR</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># model_cfg = OmegaConf.load('../config/model/image/convnetx_adam.yaml')</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># model_cfg.optimizer.lr = 0.1</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model = instantiate(model_cfg)</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># opt = instantiate(model_cfg.optimizer)</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(opt)</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="co"># sched = instantiate(model_cfg.scheduler)</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="co"># print(sched)</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>N_EPOCHS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span>N_EPOCHS,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logger=TensorBoardLogger("tb_logs", name="mnist_convnet", default_hp_metric=True),</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">=</span>CSVLogger(<span class="st">"logs"</span>, name<span class="op">=</span><span class="st">"fashion_mnist_convnet"</span>),</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"step"</span>)],</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    check_val_every_n_epoch<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">1</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a><span class="co"># use standar adam scheduler</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve last ckpt</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>trainer.fit(model, datamodule.train_dataloader(), datamodule.val_dataloader(), ckpt_path<span class="op">=</span>best_checkpoint_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (mps), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
Restoring states from the checkpoint path at /Users/slegroux/Projects/nimrod/nbs/checkpoints/epoch00-val_loss0.13.ckpt
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py:273: Be aware that when using `ckpt_path`, callbacks used to create the checkpoint need to be provided during `Trainer` instantiation. Please add the following callbacks: ["ModelCheckpoint{'monitor': 'val/loss', 'mode': 'min', 'every_n_train_steps': 0, 'every_n_epochs': 1, 'train_time_interval': None}"].
[20:56:49] INFO - Optimizer: AdamW (
Parameter Group 0
    amsgrad: False
    betas: (0.9, 0.999)
    capturable: False
    differentiable: False
    eps: 1e-08
    foreach: None
    fused: None
    lr: 0.0001
    maximize: False
    weight_decay: 1e-05
)
[20:56:49] INFO - Scheduler: &lt;torch.optim.lr_scheduler.ReduceLROnPlateau object&gt;
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/core/optimizer.py:316: The lr scheduler dict contains the key(s) ['monitor'], but the keys will be ignored. You need to call `lr_scheduler.step()` manually in manual optimization.

  | Name         | Type               | Params | Mode 
------------------------------------------------------------
0 | loss         | CrossEntropyLoss   | 0      | train
1 | train_acc    | MulticlassAccuracy | 0      | train
2 | val_acc      | MulticlassAccuracy | 0      | train
3 | test_acc     | MulticlassAccuracy | 0      | train
4 | train_loss   | MeanMetric         | 0      | train
5 | val_loss     | MeanMetric         | 0      | train
6 | test_loss    | MeanMetric         | 0      | train
7 | val_acc_best | MaxMetric          | 0      | train
8 | nnet         | ConvNet            | 110 K  | train
------------------------------------------------------------
110 K     Trainable params
0         Non-trainable params
110 K     Total params
0.440     Total estimated model params size (MB)
39        Modules in train mode
0         Modules in eval mode
Restored all states from the checkpoint at /Users/slegroux/Projects/nimrod/nbs/checkpoints/epoch00-val_loss0.13.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1783fd48263345eda3ab4aecfe1f9768","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'val_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c7ab34b3f4d541308d80adbcac69cade","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0a74162c9ee94c11a5ca89f0debffcc7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[20:57:08] INFO - scheduler is an instance of Reduce plateau</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e0ee094894bb451d9c937bba289c1333","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[20:57:26] INFO - scheduler is an instance of Reduce plateau
`Trainer.fit` stopped: `max_epochs=3` reached.</code></pre>
</div>
</div>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>csv_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trainer<span class="sc">.</span>logger<span class="sc">.</span>log_dir<span class="sc">}</span><span class="ss">/metrics.csv"</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> pd.read_csv(csv_path)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>metrics.head()</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'train/loss_step'</span>], <span class="st">'b.-'</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'val/loss'</span>],<span class="st">'r.-'</span>)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>plt.plot(metrics[<span class="st">'step'</span>], metrics[<span class="st">'lr-AdamW'</span>], <span class="st">'g.-'</span>)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>trainer.test(model, datamodule.test_dataloader(), ckpt_path<span class="op">=</span><span class="st">"best"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="models.conv_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="models.conv_files/figure-html/cell-36-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Restoring states from the checkpoint path at logs/fashion_mnist_convnet/version_14/checkpoints/epoch=2-step=282.ckpt
Loaded model weights from the checkpoint at logs/fashion_mnist_convnet/version_14/checkpoints/epoch=2-step=282.ckpt
/Users/slegroux/miniforge3/envs/nimrod/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:424: The 'test_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=11` in the `DataLoader` to improve performance.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"991eeaea9e0847349d87acaa129421e5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test/acc          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9711999893188477     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test/loss         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.11154787242412567    </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/slegroux\.github\.io\/nimrod");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/slegroux/nimrod/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>